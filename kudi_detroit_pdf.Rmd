---
header-includes: \input{preamble.tex}
fontsize: 9.5pt
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
  word_document: default
sansfont: Lato
font: Lato
geometry: left=0.65in,right=0.65in,top=0.35in,bottom=0.5in
urlcolor: null
---

\raggedright

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
```

```{r rmarkdown-setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(dev = "cairo_pdf")

library(data.table)
library(ggmap)
library(ggrepel)
library(glue)
library(gt)
library(janitor)
library(knitr)
library(kableExtra)
library(lubridate)
library(osmdata)
library(readxl)
library(scales)
library(sf)
library(sp)
library(tidycensus)
library(tidyverse)
library(tigris)
library(tinytex)
library(urbnmapr)
library(urbnthemes)
library(zoo)
```

```{r include = FALSE}
# detroit
city_title <- c("Detroit")
city_name <- c("Detroit","detroit")
city_state <- c("MI")
city_df <- c("detroit_city")
city_title_df <- c("City of Detroit")
city_dis_title_df <- c("Detroit city")

msa_name <- c("Detroit-","detroit-")
msa_state <- c("Michigan")
msa_df <- c("detroit_msa")
msa_title_df <- c("Detroit MSA")

msa_md_code <- c("19804")
```

```{r include = FALSE}
# label/table functions
percentLabel <- function(x, digits = 1, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

dollarLabel <- function(x, digits = 0, ...) {
  paste0("$", round(x, digits = digits, ...))
}

dollarLabel_k <- function(x, digits = 0, ...) {
  paste0("$", round(x/1000,  digits = digits, ...), "k")
}
```

```{r eval = FALSE}
acs_race_comp_function = function(data, ...) {
  data %>% 
    mutate(acs_year = factor(case_when(year == 2009 ~ "2005-09",
                                       year == 2014 ~ "2010-14",
                                       year == 2019 ~ "2015-19"),
                             levels = c("2005-09", "2010-14", "2015-19")),
           own = if_else(ownershp == 1, 1, 0),
           raceeth = factor(case_when(race == 1 & hispan == 0 ~ "White",
                                      race == 2 & hispan == 0 ~ "Black",
                                      race %in% c(4, 5, 6) & hispan == 0 ~ "Asian",
                                      race %in% c(3, 6, 7, 8, 9) & hispan == 0 ~ "Other",
                                      hispan != 0 ~ "Hispanic"),
                            levels=c("Asian", "Black", "Hispanic", "White", "Other")),
           hhincome = na_if(hhincome, 9999999),
           adjhhinc = ifelse(year == 2009, hhincome*255.657/214.537 ,
                             ifelse(year == 2014, hhincome*255.657/237.017, hhincome)),
           adjrent = ifelse(year == 2009, rentgrs*255.657/214.537 ,
                            ifelse(year == 2014, rentgrs*255.657/237.017, rentgrs)),
           valueh = na_if(valueh, 9999999),
           adjhv =  ifelse(year == 2009, valueh*255.657/214.537 ,
                           ifelse(year == 2014, valueh*255.657/237.017, valueh)),
           rentburden = ifelse((rentgrs*12)/hhincome>0.3 & own == 0, 1, 0),
           ownburden = ifelse((owncost*12)/hhincome>0.3 & own == 1, 1, 0))
}

acs <- fread("data/kudi_us.csv") %>% 
  select(-columbus_msa, -memphis_msa, -memphis_city, -multyear, 
         -sample, -strata, -cbserial, -cluster, -ownershpd, -raced, -hispand) %>%
  acs_race_comp_function()

acs_hh <- acs %>% 
  filter(gq!=3 & gq!=4) %>%
  filter(pernum==1)
```

```{r include = FALSE}
# acs data
acs_hh_2009 <- fread("data/acs_hh_2009.csv")
acs_hh_2014 <- fread("data/acs_hh_2014.csv")
acs_hh_2019 <- fread("data/acs_hh_2019.csv")

acs_hh <- bind_rows(acs_hh_2009, acs_hh_2014, acs_hh_2019)
```

```{r include = FALSE}
# map
cbsa_df <- core_based_statistical_areas(cb = FALSE, class = "sf") %>% 
  filter(str_detect(NAME, city_name))

counties_df <- counties(state = city_name, cb = FALSE, class = "sf") %>% 
  st_join(cbsa_df) %>% 
  filter(!is.na(NAME.y)) %>% 
  dplyr::select(NAME.x) %>% 
  st_drop_geometry() %>%  
  pull()

state_df <- states(cb = FALSE, class = "sf") %>% 
  filter(NAME == msa_state)

city_gis <- st_read("https://opendata.arcgis.com/datasets/86b221bb68ca4364afe81d156e54f95c_0.geojson") %>% 
  st_transform(crs = 4269)
```

```{r include = FALSE}
# base maps
msa_map <- get_stamenmap(bbox = c(left = -83.4050, top = 42.58, right = -82.8000, bottom = 42.1146), 
                         zoom = 11, maptype = "toner-lite")

city_map <- get_stamenmap(bbox = c(left = -83.343069, bottom = 42.224992, right = -82.841863, top = 42.475485), 
                         zoom = 11, maptype = "toner-lite")
```

```{r include = FALSE}
# holc data
holc_city <- read_sf("data/MIDetroit1939.geojson") %>% 
  # holc_city <- read_sf("data/TNMemphis19XX.geojson") %>% 
  # holc_city <- read_sf("data/OHColumbus1936.geojson") %>% 
  mutate(grade = case_when(holc_grade == "A" ~ "Best",
                           holc_grade == "B" ~ "Desirable",
                           holc_grade == "C" ~ "Declining",
                           holc_grade == "D" ~ "Hazardous"))
```

```{r include = FALSE}
# dissimilarity - city
dissim_index_city <- readxl::read_xls("data/cityalld.xls")
# dissimilarity - msa
dissim_index_msa <- readxl::read_xls("data/msaalld.xls")
```

```{r include = FALSE}
# mortgage/rent pulse
mort_rent_pulse <- fread("data/mort_rent_payment.csv") %>%
  mutate(region = str_trim(region),
         region = if_else(region == "Nation", "Nation", "Detroit")) %>%
  gather(behind, value, -region, -raceeth) %>%
  mutate(value_label = percentLabel(value)) %>%
  filter(str_detect(region, "Detroit")) %>%
  filter(raceeth != "Other") 
```

```{r include = FALSE}
city_censustract <- fread("data/city_censustracts.csv") 

city_censustract <- city_censustract %>%
  mutate(census_tract = as.numeric(census_tract))
```

```{r include = FALSE}
hmda2019_all <- fread("data/hmda_all_2019.csv") %>% 
  mutate(census_tract = as.numeric(census_tract)) %>%
  left_join(city_censustract, by = "census_tract") %>% 
  mutate(city_level = if_else(str_detect(city, city_name), 1, 0),
         city_msa = if_else(str_detect(derived_msa_md, msa_md_code), 1, 0))

hmda2019_org <- fread("data/hmda2019_org.csv") %>% 
  mutate(census_tract = as.numeric(census_tract)) %>% 
  select(-dti_num)

hmda2019_org <- left_join(hmda2019_org, city_censustract, by = "census_tract") %>% 
  mutate(detroit_city = ifelse(city == "Detroit", 1, 0)) %>% 
  mutate(detroit_msa = ifelse(derived_msa_md == "19804", 1, 0))
  
  mutate(census_tract = as.numeric(census_tract)) %>%
  dplyr::select(-dti_num) %>%
  left_join(city_censustract, by = "census_tract") %>% 
  mutate(city_level = if_else(str_detect(city, city_name), 1, 0),
         city_msa = if_else(str_detect(derived_msa_md, msa_md_code), 1, 0))
```

```{r include = FALSE}
# denial reason
denial_reason <- fread("data/Denial_Reason.csv", header = TRUE) %>%
  dplyr::select(-V7, -V8, -V9)
```

```{r include = FALSE}
credit_score <- read_excel("data/freddie_mac_mortgage_ready.xlsx", 
                       sheet = "DTI_Vantage Bucket",
                       col_names = TRUE)
```

```{r include = FALSE}
mort_ready_df <- read_excel("data/freddie_mac_mortgage_ready.xlsx", 
                       sheet = "Mortgage Ready",
                       skip = 1, col_names = TRUE)

colnames(mort_ready_df) <- c("geo","White_Mortgage Ready","White_Near Mortgage Ready",
                        "Black_Mortgage Ready","Black_Near Mortgage Ready",
                        "Hispanic_Mortgage Ready","Hispanic_Near Mortgage Ready",
                        "Asian_Mortgage Ready","Asian_Near Mortgage Ready",
                        "Other_Mortgage Ready","Other_Near Mortgage Ready")
```

```{r include = FALSE}
county_list <- c("Lapeer County","St. Clair County","Livingston County","Oakland County","Macomb County","Wayne County")

counties_sf <- get_urbn_map("counties", sf = TRUE) %>%
  filter(str_detect(msa_state, state_name)) %>%
  filter(str_detect(county_name, paste(county_list, collapse = "|"))) %>%
  mutate(county = str_remove(county_name, " County"))
```

```{r include = FALSE}
detroit_mort_ready <- fread("data/detroit_map_mortgage_ready.csv")
```


```{r include = FALSE}
time_save_df <- read_excel("data/freddie_mac_mortgage_ready.xlsx", 
                       sheet = "Time to Save Affordability",
                       skip = 1, col_names = TRUE)

colnames(time_save_df) <- c("geo",
                             "White_% Mortgage Ready",
                             "White_Affordability 2.9% Mortgage Rate",
                             "White_Time to Save 3% Downpayment (in Years)",
                             "Black_% Mortgage Ready",
                             "Black_Affordability 2.9% Mortgage Rate",
                             "Black_Time to Save 3% Downpayment (in Years)",
                             "Hispanic_% Mortgage Ready",
                             "Hispanic_Affordability 2.9% Mortgage Rate",
                             "Hispanic_Time to Save 3% Downpayment (in Years)",
                             "Asian_% Mortgage Ready",
                             "Asian_Affordability 2.9% Mortgage Rate",
                             "Asian_Time to Save 3% Downpayment (in Years)",
                             "Other_% Mortgage Ready",
                             "Other_Affordability 2.9% Mortgage Rate",
                             "Other_Time to Save 3% Downpayment (in Years)")
```

```{r include = FALSE}
city_hpi <- fread("data/detroit_city_hpi.csv") 
  
msa_hpi <- fread("data/detroit_msa_hpi.csv") 

city_tiers <- fread("data/detroit_city_tiers.csv") 

city_comp <- readxl::read_xlsx("data/cct_data.xlsx", sheet = "prices_local") 

med_price <- fread("data/med_price_det.csv")
```

```{r include = FALSE}
city_shape <- st_read("data/Census_Tracts,_Census_2010,_Michigan-shp/84d40e6c-165e-48dc-bb2e-0cf0b4548d212020329-1-z3l2tb.s0h1b.shp", stringsAsFactors = FALSE)
city_shape <- st_transform(city_shape, CRS("+proj=longlat +ellps=WGS84 +datum=WGS84"))

city_shape <- as_Spatial(city_shape)
city_tract <- fortify(city_shape, region = "GEOID10")

city_structure <- fread("data/detroit_structure.csv")
```

```{r include = FALSE}
options("scipen"=999, "digits"=15)
format(1810032000, scientific = FALSE)

hous_invent <- read_excel("data/Zillow.xlsx",
                          sheet = "Inventory",
                          col_names = TRUE)
```

```{r}
housingunits_df <- fread("data/DETR826BPPRIVSA.csv")

national_housingunits_df <- fread("data/PERMIT in Thousand - US.csv")
```

```{r}
days_pend <- read_excel("data/Zillow.xlsx",
                          sheet = "Days to Pending",
                          col_names = TRUE)
```

```{r}
hcv_voucher <- read_excel("data/Solari_HCV_Homeown_Trends_Detroit.xls",
                          sheet = "Chart",
                          col_names = TRUE)
```

\urbnlogo{}

\urbntitle{Keys Unlock Dreams:}
\urbntitle{Detroit Profile}
\urbnauthors{Urban Institute}

\newpage{}

\urbnheadingone{About the Urban Institute}

The nonprofit Urban Institute is a leading research organization dedicated to developing evidence-based insights that improve people’s lives and strengthen communities. For 50 years, Urban has been the trusted source for rigorous analysis of complex social and economic issues; strategic advice to policymakers, philanthropists, and practitioners; and new, promising ideas that expand opportunities for all. Our work inspires effective decisions that advance fairness and enhance the well-being of people and places.

\newpage{}

\urbntitle{Contents}

\urbnheadingone{Acknowledgements}

\urbnheadingone{About the Keys Unlock Dreams Initiative}

\urbnheadingone{Executive Summary}

\urbnheadingone{About the Data}

\urbnheadingone{About Detroit}

* \urbnheadingtwo{Explanation of the market: Population Household in City and MSA}
* \urbnheadingtwo{Race and Segregation in City}
* \urbnheadingtwo{Neighborhood Racial Segregation}
* \urbnheadingtwo{Neighborhood Racial Composition}

\urbnheadingone{Household Characteristics}

* \urbnheadingtwo{Homeownership Rate}
* \urbnheadingtwo{Household Income}
* \urbnheadingtwo{Gross Rent}
* \urbnheadingtwo{Housing Cost Burden - Homeowners}
* \urbnheadingtwo{Housing Cost Burden - Renters}
* \urbnheadingtwo{Housing Payment Amidst COVID-19 Pandemic}

\urbnheadingone{Mortgage and Credit}

* \urbnheadingtwo{Denial Rates}
* \urbnheadingtwo{Credit Score by Race/Ethnicity}
* \urbnheadingtwo{Debt to Income Ratio}
* \urbnheadingtwo{Loan Channel}
* \urbnheadingtwo{Loan to Value Ratio}
* \urbnheadingtwo{Mortgage Ready}

\urbnheadingone{Home Prices}

* \urbnheadingtwo{House Price Appreciation}
* \urbnheadingtwo{Home Values by Households}
* \urbnheadingtwo{Home Values by Neighborhoods}

\urbnheadingone{Housing Supply}

* \urbnheadingtwo{Housing Inventory}
* \urbnheadingtwo{Building Permits}
* \urbnheadingtwo{Days to Pending}
* \urbnheadingtwo{Housing Type}
* \urbnheadingtwo{Age of Housing}

\newpage{}

\urbnheadingone{Acknowledgements}

This report was funded by the National Fair Housing Alliance. We are grateful to them and to all our funders, who make it possible for Urban to advance its mission. The views expressed are those of the authors and should not be attributed to the Urban Institute, its trustees or its funders. Funders do not determine research findings or the insights and recommendations of Urban experts. Further information on the Urban Institute’s funding principles is available at www.urban.org/support.

\urbnheadingone{About the Keys Unlock Dreams Initiative}

Keys Unlock Dreams is a nationwide initiative led by the National Fair Housing Alliance (NFHA) to advance policies that expand equal housing opportunities and provide consumers with the resources and information they need to make homeownership a reality. 

Homeownership has always been at the heart of the American dream and provides secure and stable environments for families to build generational wealth. Yet today’s housing and financial markets have not served everyone well. Some communities are enriched with resources, like bank branches, healthcare facilities, well-resourced schools, healthy food centers, green spaces, and other important amenities. Unfortunately, other neighborhoods, largely communities of color and urban and rural areas, lack these critical resources. Many areas lack affordable housing options. 

For millions of people of color around the nation, homeownership still remains a dream. To address these inequities, the goals of Keys Unlock Dreams are to: 
\begin{urbnbullets}
  \item Remove structural barriers that perpetuate racial inequality; 
  \item Expand affordable and fair housing options; 
  \item Prevent an unbalanced recovery from the COVID-19 pandemic; 
  \item Empower consumers and stakeholders with critical information and resources; and 
  \item Help close the racial wealth and homeownership gaps.
\end{urbnbullets}

The initiative’s theory of change is to influence the way policy happens at the local, regional, and federal levels by providing tools, information, and supports as well as building coalitions to generate solutions that create equitable opportunities for vulnerable groups. This entails supporting and urging the development of programs and policies that dismantle and disrupt current systems that perpetuate inequality and replacing them with structures that create and promote fair and equitable access to housing and financial services and products. 

Offering an innovative approach, it also seeks to effectuate changes in jurisdictions’ Consolidated Plans, Assessments of Fair Housing, and Community Health Needs Assessments; ensure these plans are data-driven with up-to-date analyses; and encourage jurisdictions and communities to assess infrastructure, health, housing, finance, environment, economic, and education structures from a racial equity and fair housing lens. 

The Urban Institute is a partner in the initiative, conducting foundational research in its focus cities. Urban’s Five Point Framework for Reducing the Racial Homeownership Gap also provides an implementation framework based on this work:
\begin{urbnbullets}
  \item Advancing policy solutions at the local level 
  \item Tackling housing supply constraints and affordability 
  \item Promoting an equitable and accessible housing finance system 
  \item Furthering outreach and counseling for renters and mortgage-ready millennials 
  \item Focusing on sustainable homeownership and preservation
\end{urbnbullets}

This first profile report in support of Keys Unlocks Dreams is for the Detroit market. It is intended as a first step to informing local housing policies with a profile of homeownership barriers and opportunities, offering an evidence-based framework for policymakers and for stakeholders such as consumers and the myriad housing market industry constituents as they seek to affirmatively further fair housing to close racial homeownership and wealth gaps.

\newpage{}

\urbnheadingone{Executive Summary}

This chartbook provides a comprehensive overview of  racial disparities in the housing market in City of Detroit and its metropolitan areas. The charts demonstrate that Black households have significantly lower homeownership rates and Black homeowners live in lower-priced homes relative to other race and ethnic groups. The chartbook includes information on household socioeconomic characteristics, mortgage and credit,, home prices, and housing supply in Detroit that is all related to the lower Black homeownership and housing wealth in the region. 

It will be news to very few that the racial and ethnic composition of the City of Detroit is substantially different from the Detroit region—its Metropolitan Statistical Area or MSA—as a whole. The City population is more than 89 percent non-white, while the non-white population for the MSA is just greater than one-third. .  Not surprisingly, Black-white residential segregation is even higher in the region as a whole than compared to just the City.

These are important facts to keep in mind when absorbing how hard Detroit was hit by the Great Recession caused by the Financial Crisis of 2007-2010. Unlike the whole nation, household incomes and home values in Detroit have still not fully recovered to the level they were at before the Great Recession. The homeownership rate in the City declined from 56 percent in years 2005-2009 to 47 percent in years 2015-2019. While the homeownership rate of the MSA dropped more than the nation’s between these two periods, in years 2015-2019, it was still 5 percentage points higher—and 22 percentage points higher than in the City.

Except for Hispanic households, homeownership rates in the City have dropped continuously for all races and ethnic groups since the 2005-2009 period. The greatest drop was among Asian households. However, Asian households, only comprise 1.7 percent of the City population and their homeownership rate is twice as high in the MSA compared to the City Meanwhile, the Black homeownership rate in the MSA (42 percent) is lower there than in the City (45 percent), indicating that Black households are struggling to become homeowners in both geographies.

A greater share of households in the City compared to the MSA are housing-cost burdened (i.e., paying more than 30 percent of their income for housing expenses), especially among renters (59 percent). But Black households comprised the highest levels of cost-burdened households in both the City (31 percent of owners and 61 percent of renters) as well as in the MSA (29 percent of owners and 56 percent of renters). 

The COVID Pandemic is exacerbating these challenges. Black homeowners and renters in the MSA are more behind their mortgage and rent payment amidst the pandemic compared to white, Hispanic, and other households, which concerns the future of Black homeownership.

Home prices in Detroit were hit hard in the wake of the 2008 housing bust, losing significantly more value than the US market as a whole. Average home values in the City remain below peak value by 43 percent. In the MSA, home values have recovered for all race and ethnic groups during the last 10 years, but Black households still have the lowest median home values, showing that even among homeowners there are substantial disparities in housing wealth.

Housing supply has also fallen since the Great Recession and has become a major barrier for accessing homeownership. The number of units slowly recovered in the years after but dipped when the pandemic hit the nation. This is similar to the national trend. Housing inventory has dropped amidst the pandemic as the shortage continued while the demand went up and mortgage rates fell—all while Millennials are entering their prime home-buying age. Between January 2018 and May 2021, housing inventories fell by 31 percent in the nation, 15 percent in the City of, and 21 percent in its MSA, according to Zillow. The annual inventory per household rate was the lowest in the City, as homes selling faster in 2020 and 2021 than in years past. The housing stock in the City is also significantly older than the region as a whole, and Black households are more likely to live in older homes. 

Among those seeking to attain homeownership, 46 percent of mortgage applicants in the City were denied, compared to  21 percent of those in the MSA. Denial rates were highest for Black and Hispanic applicants. More than 50 percent of Black mortgage applicants were denied in the City and more close to 40 percent of them were denied in the metro area. Credit history was the most frequently mentioned reason for mortgage denial –  more than 50 percent of denials of Black applicants in the City 44 percent in the MSA was due to credit history.  

Black consumers have the lowest median credit score in both the nation and Detroit MSA. The median VantageScore in January 2021 of Black consumers was 629 in the US and 609 in the Detroit MSA, compared to 726 and 733 for white consumers in the US and Detroit MSA, respectively. As credit is found to be the major reason for mortgage denial among Black applicants, improving credit and considering alternative ways to evaluate credit will be necessary to increase Black homeownership.  
When it comes to moving the needle on Black homeownership in Detroit, one place to look is among the “mortgage-ready” population, which is defined by Freddie Mac as borrowers age 45 or younger who do not have a mortgage but have the credit characteristics to qualify for one. In the Detroit MSA, as of January 2021, there were close to 500,000 mortgage-ready consumers, of whom 60,000 are Black. This 18 percent share of Black mortgage-ready consumers in the MSA is lower than the nation’s 22 percent share, which can be explained by the differences in credit scores and incomes. 

However, because homes are less expensive in Detroit, a greater share of the mortgage-ready population can afford to buy median price homes, especially with the current low interest rate.  Assuming a 2.9-percent mortgage rate, 76 percent of the mortgage-ready black population can afford a mortgage compared to 45 percent in the nation as a whole.   Additionally, Freddie Mac shows that it takes less time to save for Black mortgage-ready consumers to save for 3 percent down in Detroit metro area (1.72 years) than the nation (2.71 years). These numbers show a glimpse of hope, despite numerous challenges, to increase black homeownership and housing wealth in Detroit with the right sets of actions in place. 

\newpage{}

\urbnheadingone{About the Data}

This report uses multiple datasets, including American Community Survey, Property Records, Home Mortgage Disclosure Act, Black Knight, Building Permit Survey, and Census Pulse. We also obtain credit characteristics and history data by race and ethnicity from Freddie Mac and housing inventory data from Zillow. Being aware that a small sample size could lead to statistical inaccuracy, especially at the city level, we use the 5-slowing of the postwar industrial boom, exacerbated white flight. Between the 1950 and 2010 Census Detroit lost 95 percent of its white residents, also losing its place in the top 10 most populous cities along with a significant portion of tax revenue and commercial enterprise.

Detroit’s story began changing again in 2015. An unprecedented amount of corporate and nonprofit sector investment and a robust municipal marketing effort positioned parts of the city as an ideal location for young (mostly white) professionals, tech specialists, and creatives. Blocks of foreclosed properties and blight gave way to craft breweries, bike shops, and yoga studios. Much of the investment centered around a small section of downtown now known as “7.2,” referring to the number of square miles it inhabits. This shift isn’t controversial so much for displacement of residents, but for highlighting the lack of investment in the remaining 134.8 square miles of the city. There is a stark difference in the revitalization felt in the 7.2 and disintegration in the outlying areas. While lauded by many, this revitalization was criticized by others for deepening racial and economic disparities.

The racial composition of the City of Detroit is substantially different from the Detroit MSA. In the City, more than 77 percent of the population is Black. This share is significantly higher than the nation and MSA, where the Black population accounts for 12 percent and 23 percent, respectively. The city population is more than 89 percent non-white, while the non-white population for the metro region is just greater than one-third (34 percent).



\newpage{}

\urbnheadingone{About Detroit}

The City of Detroit had a population of 670,052 with 267,139 households according to the 2019 American Community Survey. It comprised about 16% of the population (4,319,629) and households (1,720,610) of the Detroit Metropolitan Statistical Area. 

The Detroit-Warren-Dearborn MSA is the 14th-largest in the US, but has experienced small population growth (about half a percent) since the 2010 census. Detroit is the largest city in State of Michigan and is part of the state’s largest metro area. It also shares an international border with Canada, and has one of the largest metropolitan economies in the US with 17 Fortune 500 companies. The MSA has six counties and its urbanized area covers parts of Macomb, Oakland, and Wayne (the latter of which includes the City of Detroit). The Canadian city of Windsor, Ontario and its suburbs are just south across the Detroit River and have strong economic linkages.

```{r  fig.align = 'center', fig.width=8, fig.height=8.5}
set_urbn_defaults(style = "map")
urbn_plot(urbn_title(""),
          ggmap(msa_map),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}
\pagenumbering{gobble} 
\urbnheadingtwo{Race and Segregation in Detroit City}
\pagenumbering{arabic} 
Like many American cities, Detroit has endured its share of population loss, disinvestment, and gentrification. The housing and financial crisis in the late 2000s hit Detroit particularly hard, culminating in bankruptcy in 2013. The population and racial composition of the city began shifting in the late 1960s after reaching a peak of 1.8 million residents in 1950, spurred by the Great Migration and an influx of European immigrants. Racial tensions brought about by civil rights expansions – and subsequent increases in homeownership for Black individuals – coupled with slowing of the postwar industrial boom, exacerbated white flight. Between the 1950 and 2010 Census Detroit lost 95 percent of its white residents, also losing its place in the top 10 most populous cities along with a significant portion of tax revenue and commercial enterprise.

Detroit’s story began changing again in 2015. An unprecedented amount of corporate and nonprofit sector investment and a robust municipal marketing effort positioned parts of the city as an ideal location for young (mostly white) professionals, tech specialists, and creatives. Blocks of foreclosed properties and blight gave way to craft breweries, bike shops, and yoga studios. Much of the investment centered around a small section of downtown now known as “7.2,” referring to the number of square miles it inhabits. This shift isn’t controversial so much for displacement of residents, but for highlighting the lack of investment in the remaining 134.8 square miles of the city. There is a stark difference in the revitalization felt in the 7.2 and disintegration in the outlying areas. While lauded by many, this revitalization was criticized by others for deepening racial and economic disparities.

The racial composition of the City of Detroit is substantially different from the Detroit MSA. In the City, more than 77 percent of the population is Black. This share is significantly higher than the nation and MSA, where the Black population accounts for 12.3 percent and 22.5 percent, respectively. The city population is more than 89 percent non-white, while the non-white population for the metro region is just greater than one-third (34 percent).

```{r include = FALSE}
# racial composition
race_comp_1 = function(data, ...) {
  data %>% 
    group_by(raceeth) %>%
    summarize(n = sum(perwt),
              pct_n = n / sum(.$perwt))
}
```

```{r include = FALSE}
city_race_comp <- acs_hh %>%
  filter(year == 2019) %>%
  filter(!!as.symbol(city_df) == TRUE) %>%
  race_comp_1() %>%
  mutate(area = city_title_df)

msa_race_comp <- acs_hh %>%
  filter(year == 2019) %>%
  filter(!!as.symbol(msa_df) == TRUE) %>% 
  race_comp_1() %>%
  mutate(area = msa_title_df)

us_race_comp <- acs_hh %>%
  filter(year == 2019) %>% 
  race_comp_1() %>%
  mutate(area = "US") %>%
  bind_rows(city_race_comp, msa_race_comp) %>%
  mutate(value_label = percentLabel(pct_n),
         area = factor(area, levels = c("US", city_title_df, msa_title_df)),
         font = factor(case_when(raceeth == "Black" ~ "1",
                                 raceeth == "White" ~ "1",
                                 TRUE ~ as.character("0")),
                       levels = c("0","1")),
         raceeth = factor(raceeth, 
                          levels = c("Asian", "Black", "Hispanic", "White", "Other"))) %>%
  data.frame()

us_race_comp_plot <- us_race_comp %>% 
  ggplot() +
  geom_col(aes(y = pct_n, x = area, fill = raceeth), position = "fill") +
  geom_text(aes(y = pct_n, x = area, group = raceeth, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
   labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r  fig.align = 'center', fig.width=6, fig.height=4.5}
# - PLOT - RACIAL COMPOSITION
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Racial Composition Comparison"),
          us_race_comp_plot,
          urbn_source("2015-19 American Community Survey "),
          heights = c(.05, 1, .05))
```

\newpage{}

The City of Detroit was one of around 150 cities to have Home Owners’ Loan Corporation (HOLC) “Residential Security” rankings in the pre-suburbanization surge in the 1930s, which are mapped below. Much research has been done on the relationship between HOLC grades and race, a term now known as redlining, which denied neighborhoods of color access to credit for home purchases. 

```{r include = FALSE}
holc_map <- ggmap(msa_map) +
  geom_sf(data = holc_city, mapping = aes(fill = factor(grade)),
          col = NA, inherit.aes = FALSE, alpha = 0.7)+
  scale_fill_manual(name = "HOLC score",
                    values = c("#55b748", "#1696d2", "#fdbf11", "#db2b27"),
                    guide = guide_legend(ncol = 1,
                                         title.position = "top")) +
  labs(y = NULL, x = NULL) +
  theme(
    axis.ticks = element_blank(),
    axis.text.x =element_blank(),
    axis.text.y =element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside",
    plot.caption = element_text(hjust = 0),
    legend.position = "right",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8, face = "bold"))
```

```{r  fig.align = 'center', fig.width=8, fig.height=8.5}
# - MAP - HOLC MAP
set_urbn_defaults(style = "map")
urbn_plot(urbn_title(glue::glue("Historical HOLC Scoring Map: {msa_title_df}")),
          holc_map,
          urbn_source("Mapping Inequality, University of Richmond\n"),
           heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

The Black-white racial segregation in Detroit remains large, although there has been some improvement over time. The dissimilarity index, graphed below, is used to determine residential segregation of one ethnic/racial group in relation to another. The dissimilarity index measures whether one particular group is distributed across census tracts in an area in the same way as another group. A high value indicates that the two groups tend to live in different tracts. The dissimilarity between Black and white, and Hispanic and white populations increases significantly when you expand the coverage to the MSA due to the significant white population in suburban Detroit.

```{r include = FALSE}
# dissimilarity index
dis_index_function1 = function(data, ...) {
  data %>% 
  pivot_longer(!metroname, 
               names_to = "race_group",
               values_to = "dis_index")
}

dis_index_function2 = function(data, ...) {
  data %>% 
  mutate(area = factor(case_when(grepl(city_dis_title_df, metroname) ~ city_title_df,
                       TRUE ~ as.character(msa_title_df)),
                       levels = c(city_title_df, msa_title_df)),
         race_comparison = tolower(race_comparison),
         comparison_group = factor(case_when(race_comparison == "dwb" ~ "White-Black/Black-white",
                                      race_comparison == "dwh" ~ "White-Hispanic/Hispanic-white",
                                      race_comparison == "dwa" ~ "White-Asian/Asian-white",
                                      race_comparison == "dbh" ~ "Black-Hispanic/Hispanic-Black",
                                      race_comparison == "dba" ~ "Black-Asian/Asian-Black",
                                      race_comparison == "dha" ~ "Hispanic-Asian/Asian-Hispanic"),
                                   levels = c("White-Black/Black-white",
                                              "White-Hispanic/Hispanic-white",
                                              "White-Asian/Asian-white",
                                              "Black-Asian/Asian-Black",
                                              "Black-Hispanic/Hispanic-Black",
                                              "Hispanic-Asian/Asian-Hispanic")),
         year = factor(case_when(year == "80" ~ "1980",
                          year == "90" ~ "1990",
                          year == "00" ~ "2000",
                          year == "09" ~ "2009", 
                          year == "10" ~ "2010"),
                       levels = c("2010","2009","2000","1990","1980"))) %>% 
  filter(!is.na(comparison_group)) %>% 
  dplyr::select(year, area, comparison_group, dis_index)
}


dis_index_plot = function(data) {
  data %>% 
    filter(year != 1980 & year != 2000) %>%
    filter(comparison_group == "White-Asian/Asian-white" | 
           comparison_group == "White-Hispanic/Hispanic-white" |
           comparison_group == "White-Black/Black-white") %>%
    mutate(dis_index_pct = dis_index/100,
           dis_index_label = percentLabel(dis_index_pct)) %>%
   ggplot() +
   geom_bar(aes(y = comparison_group, x = dis_index_pct, fill = year),
            position="dodge", stat="identity") +
   geom_text(aes(y = comparison_group, x = dis_index_pct, 
                group = year, label = dis_index_label),
             position = position_dodge(width = 0.75),
             size = 3.05, hjust = -0.25) +
   scale_fill_manual(name = NULL, 
                     labels = c("2010","2009","1990"),
                     values = c("#000000","#fdbf11","#1696d2"),
                     guide = guide_legend(reverse = TRUE)) +
   scale_x_continuous(labels = scales::percent_format(accuracy = 1),
                      limits = c(0,1),
                      breaks = c(0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1),
                      expand = expansion(mult = c(0, 0.1))) +
   labs(y = NULL, x = "Dissimilarity index score") +
   facet_grid(rows = vars(area)) +
   theme(legend.position = "top",
         plot.caption = element_text(hjust = 0),
         axis.ticks.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank(),
         strip.text.y = element_text(angle = 0))
}
```

```{r include = FALSE}
dissim_index_city_plot <- dissim_index_city %>%
  filter(str_detect(CITYNAME, city_name)) %>%
  dplyr::select(-stname, -STATE) %>%
  rename(metroname = CITYNAME) %>%
  dis_index_function1() %>%
  separate(col = race_group, 
           into = c("race_comparison", "pop", "year"), 
           sep = "_") 
```

```{r include = FALSE}
dissim_index_plot <- dissim_index_msa %>% 
  filter(str_detect(metroname, msa_name)) %>%
  dis_index_function1() %>%
  separate(col = race_group, 
           into = c("metro", "race_comparison", "pop", "year"), 
           sep = "_") %>%
  dplyr::select(-metro) %>%
  bind_rows(dissim_index_city_plot) %>%
  dis_index_function2() %>%
  dis_index_plot() 
```

```{r fig.align = 'center', fig.width=8, fig.height=8.5}
# - PLOT - DISSIMILARITY INDEX - CITY
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Dissimilarity Index Comparison")),
          dissim_index_plot,
          urbn_source("Brown University: Diversity & Disparity"),
           heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingone{Household Characteristics}

\urbnheadingtwo{Homeownership Rate}

Compared to the years 2005-09, the homeownership rate in recent years has dropped. The City experienced the greatest decline in homeownership rate, from 56 percent in years 2005 and 2009 to 47 percent in years 2015 and 2019. While the homeownership rate of the Detroit MSA has dropped more than the nation’s between these two periods, in years 2015 to 2019 it was still 5 percentage points higher than the national rate, and 22 percentage points higher than in the City.

```{r include = FALSE}
# homeownership rate
home_rate_1 = function(data, ...) {
  data %>% 
  group_by(acs_year) %>% 
  summarise(ho_rate = sum(hhwt[own == 1])/sum(hhwt)) %>%
  mutate(val_lab2009 = if_else(acs_year == "2005-09", percentLabel(ho_rate), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", percentLabel(ho_rate), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}

home_rate_plot = function(data) {
  data %>% 
  ggplot(mapping = aes(x = acs_year, y = ho_rate, group = area, color = area)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0.15,0.85)) +
  geom_text(aes(y = ho_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 3.05, hjust = -1.0, direction = "y",
            color = "#000000") +
  geom_text(aes(y = ho_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 3.05, hjust = 2.75, direction = "y",
            color = "#000000") + 
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)
}
```

```{r include = FALSE}
msa_home_rate <- acs_hh %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>% 
  home_rate_1() %>%
  mutate(area = msa_title_df)

city_home_rate <- acs_hh %>% 
  filter(!!as.symbol(city_df) == TRUE) %>%
  home_rate_1() %>%
  mutate(area = city_title_df)

us_home_rate_plot <- acs_hh %>% 
  home_rate_1() %>%
  mutate(area = "US") %>%
  bind_rows(city_home_rate, msa_home_rate) %>% 
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  home_rate_plot()
```

```{r fig.align = 'center', fig.width=8, fig.height=3.25}
# - PLOT - HOMEOWNERSHIP RATE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Homeownership Rate Comparison"),
          us_home_rate_plot,
          urbn_source("American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

```{r include = FALSE}
home_rate_2 = function(data, ...) {
  data %>% 
  group_by(raceeth, acs_year) %>% 
  summarise(ho_rate = sum(hhwt[own == 1])/sum(hhwt)) %>%
  mutate(num_year = case_when(acs_year == "2005-09" ~ 1,
                              acs_year == "2010-14" ~ 2,
                              acs_year == "2015-19" ~ 3)) %>%
  mutate(val_lab2009 = if_else(acs_year == "2005-09", percentLabel(ho_rate), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", percentLabel(ho_rate), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}
```


```{r include = FALSE}
city_race_home_rate <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(city_df) == TRUE) %>%  
  home_rate_2() %>%
  mutate(area = city_title_df)

race_home_rate <- acs_hh %>%
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  home_rate_2() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_race_home_rate)
  
race_home_rate_plot <- race_home_rate %>% 
  ggplot(mapping = aes(x = acs_year, y = ho_rate, color = raceeth, group = raceeth)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0.15,0.85)) +
  geom_text_repel(aes(y = ho_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = ho_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
    facet_grid(cols = vars(area)) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

Except for Hispanic households, the homeownership rate of all race and ethnicity in the City of Detroit has dropped continuously over the three periods. The greatest drop was among the Asian households, but Asians account for less than 2percent of the city population and their homeownership rate is twice as higher in the whole metro area compared to the city. The median household income of Asians in the MSAs is also more than double that of those who live in the city, suggesting that higher income Asians are not residing in the city area. On the other hand, the Black homeownership rate in the Detroit MSA is lower than that in the city, showing that Black households are struggling to become homeowners in both areas.

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - HOMEOWNERSHIP RATE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Homeownership Rate by Race & Ethnicity"),
          race_home_rate_plot,
          urbn_source("American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Household Income}

The median household income has dropped following the Great Recession but has recovered since. However, while the median household income in the US between years 2015 and 2019 fully recovered and exceeded the levels between 2005 and 2009, the most recent median household income for both the City of Detroit and the MSA is still lower than what it was between 2005 and 2009. Additionally, the median household income in  the City of Detroit is only half of that in Detroit MSA.

```{r}
# household income
hh_inc_1 = function(data, ...) {
  data %>% 
  group_by(acs_year) %>% 
  summarise(med_income = median(rep(adjhhinc, hhwt))) %>%
  mutate(val_lab2009 = if_else(acs_year == "2005-09", dollarLabel_k(med_income), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", dollarLabel_k(med_income), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}

hh_inc_2 = function(data, ...) {
  data %>% 
  group_by(acs_year, raceeth) %>% 
  summarise(med_income = median(rep(adjhhinc, hhwt))) %>%
  mutate(val_lab2009 = if_else(acs_year == "2005-09", dollarLabel_k(med_income), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", dollarLabel_k(med_income), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}

home_rate_plot = function(data) {
  data %>% 
  ggplot(mapping = aes(x = acs_year, y = ho_rate, group = area, color = area)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0.15,0.85)) +
  
  geom_text_repel(aes(y = ho_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = ho_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)
}
```


```{r include = FALSE}
city_hh_inc <- acs_hh %>% 
  filter(!!as.symbol(city_df) == TRUE) %>%  
  hh_inc_1() %>%
  mutate(area = city_title_df)

msa_hh_inc <- acs_hh %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  hh_inc_1() %>%
  mutate(area = msa_title_df)

hh_inc_plot <- acs_hh %>% 
  hh_inc_1() %>% 
  mutate(area = "US") %>%
  bind_rows(city_hh_inc, msa_hh_inc) %>% 
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot(mapping = aes(x = acs_year, y = med_income, group = area, color = area)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::dollar,
                     limits = c(0,85000)) +
  geom_text_repel(aes(y = med_income, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2.5, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = med_income, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2.5, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)
```

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
# - PLOT - HOUSEHOLD INC
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Median Household Income Comparison"),
          hh_inc_plot,
          urbn_source("American Community Survey"),
          urbn_note("2019 Inflation Adjusted Dollars"),
          heights = c(0.05, 1, 0.05, 0.05))
```

There are noticeable disparities among race and ethnicity in the median household income in both the City of Detroit and the Detroit MSA, and the gap is much wider in the MSA than in the city. In both areas, Black households have the lowest median household income: $30,000 in the city, and $36,366 in the MSA.

```{r include = FALSE}
city_race_hh_inc <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(city_df) == TRUE) %>% 
  hh_inc_2() %>%
  mutate(area = city_title_df)

race_hh_inc <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  hh_inc_2() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_race_hh_inc)

race_hh_inc_plot <- race_hh_inc %>%
  ggplot(mapping = aes(x = acs_year, y = med_income, color = raceeth, group = raceeth)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::dollar,
                     limits = c(15000,100000)) +
  geom_text_repel(aes(y = med_income, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = med_income, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
    facet_grid(cols = vars(area)) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - HOUSEHOLD INC BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Median Household Income by Race & Ethnicity"),
          race_hh_inc_plot,
          urbn_source("American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Gross Rent}

Gross rent adds utility payment to contract rent. Median gross rent is the lowest in the City of Detroit. However, compared to the home value gaps (page XX), the median rent gap across the three areas is much smaller. The median gross rent in the City of Detroit between the years 2015 and 2019 was $800, $132 lower than Detroit MSA and $223 lower than the whole nation.

```{r include = FALSE}
gross_rent_1 = function(data, ...) {
  data %>% 
  filter(own == 0) %>% 
  group_by(acs_year) %>% 
  summarise(med_rent = median(rep(adjrent, hhwt))) %>%
  mutate(val_lab2009 = if_else(acs_year == "2005-09", dollarLabel(med_rent), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", dollarLabel(med_rent), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}

gross_rent_2 = function(data, ...) {
  data %>% 
  filter(own == 0) %>% 
  group_by(acs_year, raceeth) %>% 
  summarise(med_rent = median(rep(adjrent, hhwt))) %>%
  mutate(val_lab2009 = if_else(acs_year == "2005-09", dollarLabel(med_rent), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", dollarLabel(med_rent), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}
```


```{r include = FALSE}
city_gross_rent <- acs_hh %>% 
  filter(!!as.symbol(city_df) == TRUE) %>%  
  gross_rent_1() %>%
  mutate(area = city_title_df)

msa_gross_rent <- acs_hh %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  gross_rent_1() %>%
  mutate(area = msa_title_df)

gross_rent_plot <- acs_hh %>%
  gross_rent_1 %>% 
  mutate(area = "US") %>%
  bind_rows(city_gross_rent, msa_gross_rent) %>% 
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot(mapping = aes(x = acs_year, y = med_rent, group = area, color = area)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::dollar,
                     limits = c(250,1250)) +
  geom_text_repel(aes(y = med_rent, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2.5, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = med_rent, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2.5, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Median Rent Comparison"),
          gross_rent_plot,
          urbn_source("American Community Survey"),
          urbn_note("2019 Inflation Adjusted Dollars"),
          heights = c(0.05, 1, 0.05, 0.05))
```

There are also racial and ethnic disparities in the median rent in both the City of Detroit and MSA, but the gap is small relative to other figures in this report. In years between 2015 and 2019, in the city, Hispanic households paid the lowest median rent of $732, while in the MSA, Black households paid the lowest median rent of $885.

```{r include = FALSE}
city_race_gross_rent <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(city_df) == TRUE) %>% 
  gross_rent_2() %>%
  mutate(area = city_title_df)

race_gross_rent <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  gross_rent_2() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_race_gross_rent)

race_gross_rent_plot <- race_gross_rent %>%
  ggplot(mapping = aes(x = acs_year, y = med_rent, color = raceeth, group = raceeth)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::dollar,
                     limits = c(250,1250)) +
  geom_text_repel(aes(y = med_rent, x = acs_year, group = acs_year, label = val_lab2019), 
          size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = med_rent, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
    facet_grid(cols = vars(area)) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - GROSS RENT BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Median Rent by Race & Ethnicity"),
          race_gross_rent_plot,
          urbn_source("American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Housing Cost Burden - Homeowners}

Housing cost burden for homeowners are measured by the share of monthly payment for housing, which includes mortgage payment, property taxes, insurance, and utility payment, over monthly household income. If this number exceeds 30 percent, then the household is assumed to be housing cost burdened. The share of housing cost burdened homeowners has dropped with the decline in the mortgage interest rate over time. Nevertheless, slightly less than one-third of the homeowners in the City of Detroit are housing cost burdened, 8 percentage points higher than the share in the US, and 10 percentage points higher than the share in the Detroit MSA. 

```{r include = FALSE}
home_burden_1 = function(data, ...) {
  data %>% 
  filter(own == 1) %>%
  filter(ownburden != "NA") %>% 
  group_by(acs_year) %>% 
  summarise(ob_rate = sum(hhwt[ownburden == 1])/sum(hhwt)) %>% 
  mutate(val_lab2009 = if_else(acs_year == "2005-09", percentLabel(ob_rate), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", percentLabel(ob_rate), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}

home_burden_2 = function(data, ...) {
  data %>% 
  filter(own == 1) %>%
  filter(ownburden != "NA") %>%   
  group_by(acs_year, raceeth) %>% 
  summarise(ob_rate = sum(hhwt[ownburden == 1])/sum(hhwt)) %>% 
  mutate(val_lab2009 = if_else(acs_year == "2005-09", percentLabel(ob_rate), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", percentLabel(ob_rate), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}
```

```{r include = FALSE}
city_home_burden <- acs_hh %>% 
  filter(!!as.symbol(city_df) == TRUE) %>%  
  home_burden_1() %>% 
  mutate(area = city_title_df)

msa_home_burden <- acs_hh %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  home_burden_1() %>%
  mutate(area = msa_title_df)

home_burden_plot <- acs_hh %>%
  filter(ownburden != "NA") %>% 
  home_burden_1() %>% 
  mutate(area = "US") %>%
  bind_rows(city_home_burden, msa_home_burden) %>% 
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot(mapping = aes(x = acs_year, y = ob_rate, group = area, color = area)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0,0.55)) +
  geom_text_repel(aes(y = ob_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2.5, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = ob_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2.5, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)
```

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Housing Cost Burden Comparison: Homeowners"),
          home_burden_plot,
          urbn_source("American Community Survey"),
          urbn_note("2019 Inflation Adjusted Dollars"),
          heights = c(0.05, 1, 0.05, 0.05))
```

In the city, the share of housing cost burdened households does not differ much by race and ethnicity. In the MSA, Black households are more likely to be housing cost burden than other households. Overall, the housing cost burden for homeowners has dropped for all race and ethnic groups in both areas.

```{r}
city_race_home_burden <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(city_df) == TRUE) %>% 
  home_burden_2() %>%
  mutate(area = city_title_df)

race_home_burden <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  home_burden_2() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_race_home_burden)

race_home_burden_plot <- race_home_burden %>%
  ggplot(mapping = aes(x = acs_year, y = ob_rate, color = raceeth, group = raceeth)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0,0.55)) +
  geom_text_repel(aes(y = ob_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = ob_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
    facet_grid(cols = vars(area)) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - OWN BURDEN BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Own Burden by Race & Ethnicity"),
          race_home_burden_plot,
          urbn_source("American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Housing Cost Burden - Renters}

Housing cost burdened households for renters are those who pay more than 30 percent of the income on rent. The share housing cost burdened renters have not changed much over time and are substantially higher compared to homeowners In the City of Detroit, where the rents have continuously fallen over time, the rent burden households have decreased the most. Still, the city has the greatest share of rent burdened households among the three comparison geographies. Additionally, the city has the lowest homeownership rate. This indicates that the overall share of housing cost burdened households in the City of Detroit is substantially higher than the MSAs and the nation as a whole.

```{r include = FALSE}
rent_burden_1 = function(data, ...) {
  data %>% 
  filter(own == 0) %>% 
  filter(rentburden != "NA") %>%
  group_by(acs_year) %>% 
  summarise(rb_rate = sum(hhwt[rentburden == 1])/sum(hhwt)) %>% 
  mutate(val_lab2009 = if_else(acs_year == "2005-09", percentLabel(rb_rate), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", percentLabel(rb_rate), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}

rent_burden_2 = function(data, ...) {
  data %>% 
  filter(own == 0) %>%
  filter(rentburden != "NA") %>%
  group_by(acs_year, raceeth) %>% 
  summarise(rb_rate = sum(hhwt[rentburden == 1])/sum(hhwt)) %>% 
  mutate(val_lab2009 = if_else(acs_year == "2005-09", percentLabel(rb_rate), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", percentLabel(rb_rate), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")
}
```

```{r include = FALSE}
city_rent_burden <- acs_hh %>%
  filter(!!as.symbol(city_df) == TRUE) %>%  
  rent_burden_1() %>% 
  mutate(area = city_title_df)

msa_rent_burden <- acs_hh %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  rent_burden_1() %>%
  mutate(area = msa_title_df)

rent_burden_plot <- acs_hh %>%
  filter(rentburden != "NA") %>% 
  rent_burden_1() %>% 
  mutate(area = "US") %>%
  bind_rows(city_rent_burden, msa_rent_burden) %>% 
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot(mapping = aes(x = acs_year, y = rb_rate, group = area, color = area)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0.2,0.75)) +
  geom_text_repel(aes(y = rb_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2.5, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = rb_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2.5, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)
```

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Housing Cost Burden Comparison: Renters"),
          rent_burden_plot,
          urbn_source("American Community Survey"),
          urbn_note("2019 Inflation Adjusted Dollars"),
          heights = c(0.05, 1, 0.05, 0.05))
```

A higher share of Black renters in both the City of Detroit and the Detroit MSA are rent burdened, reflecting their relatively lower income. Between the years 2015 and 2019, about 60 percent of Black renters in the City of Detroit and 56 percent of those in the Detroit MSA were rent burdened.

```{r}
city_race_rent_burden <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(city_df) == TRUE) %>% 
  rent_burden_2() %>%
  mutate(area = city_title_df)

race_rent_burden <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(msa_df) == TRUE) %>%  
  rent_burden_2() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_race_rent_burden)

race_rent_burden_plot <- race_rent_burden %>%
  ggplot(mapping = aes(x = acs_year, y = rb_rate, color = raceeth, group = raceeth)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(.2,0.75)) +
  geom_text_repel(aes(y = rb_rate, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = rb_rate, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
    facet_grid(cols = vars(area)) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - OWN BURDEN BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Rent Burden by Race & Ethnicity"),
          race_rent_burden_plot,
          urbn_source("American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Housing Payment Amidst COVID-19 Pandemic}

In Detroit MSA, 8 percent of Black homeowner households said they were not caught up on their mortgage payment and 25 percent of Black renter households said they were behind rent, between October 28, 2020, and March 29, 2021. Unfortunately, these numbers are not available for the City of Detroit, where the numbers are likely to be worse. The racial disparities in the housing payment amidst the pandemic raise concern that the existing gaps in homeownership, housing wealth, and housing cost burden are likely to increase in the future if we don’t act with appropriate policies and strategies.

```{r include = FALSE}
mort_rent_plot = function(data) {
  data %>% 
  ggplot() +
  geom_col(aes(y = value, x = raceeth, fill = raceeth), show.legend = FALSE) +
  geom_text(aes(y = value, x = raceeth, label = value_label), 
            vjust = -1, size = 3, color = "black") +
  scale_fill_manual(name = NULL,
                    labels = c("All","Asian","Black","Hispanic","White"),
                    values = c("#ec008b","#1696d2","#fdbf11","#000000","#d2d2d2")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)),
                     labels = scales::percent_format(accuracy = 1)) +
  facet_grid(cols = vars(behind_cat)) +
    remove_axis() +
    remove_ticks() +
  labs(x = NULL,
       y = NULL) +
  theme(legend.position = "top",
         plot.caption = element_text(hjust = 0),
         axis.ticks.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank(),
         strip.text.y = element_text(angle = 0),
        strip.placement = "outside")
}

pulse_plot <- mort_rent_pulse %>% 
  mutate(behind_cat = case_when(behind == "behind_mort" ~ "Mortgage",
                                behind == "behind_rent" ~ "Rent")) %>%
  mort_rent_plot()
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - NOT CAUGHT UP ON PAYMENTS
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("% Not Caught Up on Mortgage or Rent Payment: {msa_title_df}")),
          pulse_plot,
          urbn_source("Census Pulse: October 28, 2020 - March 29, 2021"),
          urbn_note("Bi-weekly Census data was aggregated to increase the sample size."),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingone{Mortgage and Credit}

\urbnheadingtwo{Denial Rates}

```{r include = FALSE}
denial_rate_1 = function(data, ...) {
  data %>% 
  filter(based_denied == 1) %>%
  summarise(denial_rate = sum(n[denied == 1])/sum(n)) %>%
  mutate(value_label = percentLabel(denial_rate))
}

denial_rate_2 = function(data, ...) {
  data %>% 
  filter(based_denied == 1) %>%
  filter(raceeth!="-2"& raceeth!="Others") %>% 
  group_by(raceeth) %>% 
  summarise(denial_rate = sum(n[denied == 1])/sum(n)) %>%
  mutate(value_label = percentLabel(denial_rate))
}

denial_rate_df <- hmda2019_all %>%
  mutate(denied = if_else(action_taken==3|action_taken==7, 1, 0)) %>%
  mutate(based_denied = if_else(action_taken<4|action_taken>6, 1,0)) %>% 
  mutate(n = 1) %>% 
  mutate(denial_reason = factor(case_when(denial_reason_1 == 1 ~ "DTI ratio",
                                   denial_reason_1 == 2 ~ "Employment History",
                                   denial_reason_1 == 3 ~ "Credit History",
                                   denial_reason_1 == 4 ~ "Collateral",
                                   denial_reason_1 == 5 ~ "Insufficient Cash",
                                   denial_reason_1 == 6 ~ "Unverifiable Information",
                                   denial_reason_1 == 7 ~ "Credit Application Incomplete",
                                   denial_reason_1 == 8 ~ "Mortgage Insurance Denied",
                                   denial_reason_1 == 9 ~ "Other",
                                   denial_reason_1 < 0 ~ "Missing"),
                                levels = c("DTI ratio",
                                           "Employment History",
                                           "Credit History",
                                           "Collateral",
                                           "Insufficient Cash",
                                           "Unverifiable Information",
                                           "Credit Application Incomplete",
                                           "Mortgage Insurance Denied",
                                           "Other",
                                           "Missing")))  
```


```{r include = FALSE}
city_denial_rate <- denial_rate_df %>% 
  filter(city_level == 1) %>% 
  denial_rate_1() %>% 
  mutate(area = city_title_df)

msa_denial_rate <- denial_rate_df %>% 
  filter(city_msa == 1) %>% 
  denial_rate_1() %>%  
  mutate(area = msa_title_df)

denial_rate_plot <- denial_rate_df %>%
  denial_rate_1() %>% 
  mutate(area = "US") %>%
  bind_rows(city_denial_rate, msa_denial_rate) %>%
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot() +
  geom_col(aes(x = area, y = denial_rate, fill = area), position = "dodge", width = 0.9, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent) +
  geom_text(aes(x = area, y = denial_rate, label = value_label),
            position = position_dodge(width = 0.87),
            size = 3,
            vjust = -1) +
  labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank())
```

In 2019, 46 percent of borrowers who applied to purchase a home in the City of Detroit were denied getting a mortgage. By comparison, the mortgage denial rate was 21 percent in the US and 24 percent in the Detroit MSA.

```{r fig.align = 'center', fig.width=6, fig.height=2.5}
# - PLOT - DENIAL BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Denial by Comparison"),
          denial_rate_plot,
          urbn_source("2019 Home Mortage Disclosure Act"),
          heights = c(0.05, 1, 0.05, 0.05))
```

Black homebuyers in both the city and the MSA were more likely to get their mortgage application rejected. More than half of the Black mortgage applicants in the City of Detroit and almost 40 percent of the mortgage applicants in the Detroit MSA were denied.

```{r include = FALSE}
city_race_denial_rate_plot <- denial_rate_df %>%
  filter(city_level == 1) %>%
  denial_rate_2() %>%
  mutate(area = city_title_df)
  
race_denial_rate_plot <- denial_rate_df %>%
  filter(city_msa == 1) %>%
  denial_rate_2() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_race_denial_rate_plot) %>%
  ggplot() + 
  geom_col(aes(x = raceeth, y = denial_rate, fill = raceeth),
           position = "dodge", width = 0.9, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)),
                     labels = scales::percent,
                     limits = c(0,0.6)) +
  geom_text(aes(x = raceeth, y = denial_rate, label = value_label),
            position = position_dodge(width = 0.87),
            size = 3,
            vjust = -1) +
   facet_grid(cols = vars(area)) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
# - PLOT - DENIAL RATE BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Denial Rate by Race & Ethnicity"),
          race_denial_rate_plot,
          urbn_source("2019 Home Mortage Disclosure Act"),
          urbn_note("Purchase Mortgage Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

Among denied mortgages, (1) credit history, (2) Debt-to-Income ratio, and (3) collateral were the three frequently mentioned reasons for the denial. For Black households, over 50 percent of denial in the City of Detroit and 44 percent of in the Detroit MSA were denied because of the credit history.

```{r include = FALSE}
# denial reason
denial_reason_df <- denial_reason %>% 
  mutate(reason = factor(denial_reason,
                         levels = c("Credit History","DTI ratio","Collateral")),
         Asian = str_replace(Asian, "0%", "%"),
         Black = str_replace(Black, "0%", "%"),
         Hispanic = str_replace(Hispanic, "0%", "%"),
         White = str_replace(White, "0%", "%")) %>%
  dplyr::select(-denial_reason) %>%
  gather(raceeth, ratio, -reason, -geo) %>%
  spread(raceeth, ratio) %>%
  pivot_wider(names_from = "geo", 
             values_from = c(Asian, Black, Hispanic, White))
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
set_urbn_defaults(style = "print")
denial_reason_df %>%
  gt() %>%
  tab_header(
    title = md("**Table 1. Reason for Denial**")
  ) %>%
  fmt_markdown(
    columns = reason
  ) %>%
   tab_spanner(
    label = glue::glue("{city_title_df}"),
    columns = c("Asian_City","Black_City","Hispanic_City","White_City")
  ) %>%
   tab_spanner(
    label = glue::glue("{msa_title_df}"),
    columns = c("Asian_MSA","Black_MSA","Hispanic_MSA","White_MSA")
  ) %>%
  cols_label(
    reason = "Reason",
    `Asian_City` = "Asian",
    `Black_City` = "Black",
    `Hispanic_City` = "Hispanic",
    `White_City` = "White",
    `Asian_MSA` = "Asian",
    `Black_MSA` = "Black",
    `Hispanic_MSA` = "Hispanic",
    `White_MSA` = "White"
  ) %>%
  tab_source_note(
    source_note = md("**Source**: 2019 Home Mortgage Disclosure Act")
  ) %>%
  tab_source_note(
    source_note = md("**Note**: Purchased Loans Only")
  )
```

\urbnheadingtwo{Credit Score}

Black people have the lowest median credit score in both the nation and Detroit MSA. The January 2021 median Vantage score of Black people in the US was 629 and 609 in Detroit MSA, compared to 726 and 733 for white people in the US and Detroit MSA, respectively.

```{r include = FALSE}
credit_score_1 = function(data, ...) {
  data %>% 
  slice(-c(25:27)) %>%
  fill(Geographics) %>%
  rename(raceeth = `Race and Ethnicity`) %>%
  mutate(raceeth = str_trim(raceeth),
         raceeth = case_when(raceeth == "All Population" ~ "Total",
                             raceeth == "Black Americans" ~ "Black",
                             raceeth == "Non-hispanic Whites" ~ "White",
                             raceeth == "Other Minority" ~ "Other",
                             TRUE ~ as.character(raceeth))) %>%
  filter(raceeth != "Total" & raceeth != "Other")
}

msa_credit_score <- credit_score %>% 
  credit_score_1() %>%
  filter(grepl(c(msa_name), Geographics)) %>%
  gather(variable, value, -Geographics, -raceeth) %>%
  mutate(area = msa_title_df)

credit_score_plot <- credit_score %>% 
  credit_score_1() %>%
  filter(grepl("United States", Geographics)) %>%
  gather(variable, value, -Geographics, -raceeth) %>%
  mutate(area = "United States") %>%
  bind_rows(msa_credit_score) %>%
  filter(variable == "Median Vantage Score") %>%
  mutate(area = factor(area, levels = c("United States", msa_title_df)),
         value = round(value, digits = 0)) %>%
  ggplot() +
  geom_col(aes(y = value, x = area, fill = raceeth),
           position = position_dodge(width = 0.9)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  geom_text(aes(x = area, y = value, group = raceeth, label = value),
            position = position_dodge(width = 0.9),
            size = 3,
            vjust = -1) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
# - PLOT - CREDIT
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Credit Score Comparison"),
          credit_score_plot,
          urbn_source("2021 Freddie Mac"),
          heights = c(0.05, 1, 0.05, 0.05))
```

```{r include = FALSE}
race_msa_credit_score_plot <- credit_score %>% 
  credit_score_1() %>%
  filter(grepl(c(msa_name), Geographics)) %>%
  gather(variable, value, -Geographics, -raceeth) %>%
  mutate(area = msa_title_df) %>%
  filter(grepl("Vantage Score Less than 600 pct|Vantage Score 600-660 pct|Vantage Score 661-780 pct|Vantage Score higher than 780 pct", variable)) %>%
  mutate(variable = str_replace(variable, "Vantage Score higher than ", "Higher than "),
         variable = str_replace(variable, "Vantage Score ", ""),
         variable = str_replace(variable, " pct", ""), 
         variable = factor(variable, levels = c("Less than 600", "600-660", "661-780", "Higher than 780")),
         value_label = percentLabel(value),
         font = factor(case_when(variable == "600-660" ~ "1",
                                 variable == "Higher than 780" ~ "1",
                                 TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  ggplot() +
  geom_col(aes(y = value, x = raceeth, fill = variable), position = "fill") +
  geom_text(aes(y = value, x = raceeth, group = variable, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL) +
    theme(legend.position = "top",
        #aspect.ratio = 1.25,
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside")
```

In Detroit MSA, close to half of the Black people have a Vantage score less than 600, the highest among all race and ethnic groups. Credit is the most frequently mentioned reason for mortgage denial, and it is concerning that so many Black people have a significantly low credit score.

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
# - PLOT - CREDIT/RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Credit Score by Race & Ethnicity: {msa_title_df}")),
          race_msa_credit_score_plot,
          urbn_source("2021 Freddie Mac"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Debt to Income Ratio}

The share of borrowers with a high DTI ratio in the City of Detroit is slightly lower than in the MSA and the US as a whole. About 34% of homebuyers in the City, 36 % in the MSA, and 41% in the US had a DTI ratio of 40% or higher. This is mainly because the property values in the City of Detroit are substantially lower than the other two geographic comparison areas.

```{r include = FALSE}
dti_function = function(data, ...) {
  data %>% 
  group_by(dti) %>% 
  filter(dti!="NA") %>% 
  summarize(n = sum(n),
            pct_n = n / sum(.$n))
}
    
dti_plot_func = function(data, ...) {
  data %>% 
  group_by(raceeth) %>% 
  count(dti) %>%
  drop_na(dti) %>%
  mutate(share = n/sum(n),
         ratio = percentLabel(share),
         font = factor(case_when(dti == "20-29%" ~ "1",
                          dti == "40-45%" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  arrange(raceeth, desc(dti)) %>%
  ggplot() +
  geom_col(aes(y = share, x = raceeth, fill = dti)) +
  geom_text(aes(y = share, x = raceeth, group = dti, label = share, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  labs(y = NULL, x = NULL, fill = NULL) +
  facet_wrap(.~area,
             strip.position = "bottom") +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank(),
        strip.placement = "outside") +
  guides(fill = guide_legend(nrow = 1)) 
}
```

```{r include = FALSE}
purchase <- hmda2019_org %>%
  filter(loan_purpose==1) %>% 
  mutate(dti_num = case_when(debt_to_income_ratio == "<20%" ~ "19",
                             debt_to_income_ratio == "20%-<30%" ~ "25",
                             debt_to_income_ratio == "30%-<36%" ~ "33",
                             debt_to_income_ratio == "50%-60%" ~ "55",
                             debt_to_income_ratio == ">60%" ~ "61",
                             debt_to_income_ratio == "Exempt" ~ "99",
                             is.na(debt_to_income_ratio) ~ as.character(NA),
                             TRUE ~ debt_to_income_ratio),
         dti_num = ifelse(dti_num == "99",
                          as.integer(NA),
                          as.integer(dti_num)),
         dti = factor(case_when(dti_num >= 0 & dti_num <= 19 ~ '<20%',
                         dti_num >= 20 & dti_num <= 29 ~ '20-29%',
                         dti_num >= 30 & dti_num <= 39 ~ '30-39%',
                         dti_num >= 40 & dti_num <= 45 ~ '40-45%',
                         dti_num >= 46 & dti_num <= 50 ~ '46-50%',
                         dti_num > 50 ~ '>50%'), 
                      levels = c("<20%", "20-29%", "30-39%",
                                 "40-45%", "46-50%", ">50%")),
         ltv = factor(case_when(loan_to_value_ratio<80 ~ "<80%",
                         loan_to_value_ratio >= 80 & loan_to_value_ratio<90 ~ "80-89%",
                         loan_to_value_ratio >= 90 & loan_to_value_ratio<100 ~ "90-99%",
                         loan_to_value_ratio >= 100 ~ ">100%"),
                      levels = c("<80%", "80-89%", "90-99%", ">100%")),
         channel = factor(case_when(loan_type == 1 ~ "Conventional",
                             loan_type == 2 ~ "FHA",
                             loan_type == 3 ~ "VA",
                             loan_type == 4 ~ "RHS/FSA"),
                          levels = c("Conventional", "FHA", "VA",
                                              "RHA/FSA")),
         n = 1)
```

```{r}
purchase_city <- purchase %>%
 filter(detroit_city == 1) %>% 
 dti_function() %>% 
 mutate(area = city_title_df)

us <- purchase %>%
  dti_function() %>% 
  mutate(area = "US")

detroit_msa <- purchase %>%
  filter(detroit_msa == 1) %>% 
  dti_function() %>% 
  mutate(area = msa_title_df)

percentData <- bind_rows(us, detroit_city, detroit_msa) %>% 
  mutate(pct_n = scales::percent_format(accuracy = 0.1)(pct_n)) %>% 
  arrange(area, desc(dti))

dti <- bind_rows(us, detroit_city, detroit_msa) %>% 
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>% 
  ggplot(mapping = aes(x = area, y = n, fill = dti)) +
  geom_col(position = "fill") +
  geom_text(data = percentData, aes(y = n , label = pct_n), 
            position = position_fill(reverse = FALSE, vjust = 0.5), size = 3, color = "white") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  remove_ticks() + 
  remove_axis() +
  labs(x = NULL,
       y = NULL)

urbn_plot(urbn_title("DTI Distribtion Comparison"),
          dti,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          heights = c(.05, 1, .05))
```


```{r include = FALSE}
purchase_city <- purchase_df %>%
  filter(city_level == 1) %>% 
  dti_function() %>%
  mutate(area = city_title_df)

purchase_msa <- purchase_df %>%
  filter(city_msa == 1) %>% 
  dti_function() %>%
  mutate(area = msa_title_df)

dti_purchase_plot <- purchase_df %>%
  dti_function() %>%
  mutate(area = "US") %>%
  bind_rows(purchase_city, purchase_msa) %>%
  mutate(value_label = percentLabel(pct_n),
         area = factor(area, levels = c("US", city_title_df, msa_title_df)),
         font = factor(case_when(dti == "20-29%" ~ "1",
                          dti == "40-45%" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>% 
  ggplot() +
  geom_col(aes(y = pct_n, x = area, fill = dti)) +
  geom_text(aes(y = pct_n, x = area, group = dti, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
   labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=6, fig.height=3.5}
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("2019 DTI Ratios Comparison"),
          dti_purchase_plot,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          urbn_note("Purchased Loans Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

Despite low property values, Black borrowers in Detroit, on average, have high debt-to-income (DTI) ratios. In both the city and MSA, Black homebuyers have the highest share of DTI ratios above 40 percent across all race and ethnic groups. The share of DTI ratios over 40 percent in the city is lower at 39percent, compared to the MSA at 45 percent.

```{r include = FALSE}
race_city_dti_purchase_plot <- purchase_df %>% 
  filter(raceeth!="-2" & raceeth!="AIAN" & raceeth!="NHPI") %>%
  filter(city_level == 1) %>%
  mutate(area = city_title_df)

race_msa_dti_purchase_plot <- purchase_df %>% 
  filter(raceeth!="-2" & raceeth!="AIAN" & raceeth!="NHPI") %>%
  filter(city_msa == 1) %>%
  mutate(area = msa_title_df) %>%
  bind_rows(race_city_dti_purchase_plot) %>%
  mutate(area = factor(area, levels = c(city_title_df, msa_title_df))) %>%
  group_by(area, raceeth) %>% 
  count(dti) %>%
  drop_na(dti) %>%
  mutate(share = n/sum(n),
         ratio = percentLabel(share),
         font = factor(case_when(dti == "20-29%" ~ "1",
                          dti == "40-45%" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  arrange(raceeth, desc(dti)) %>%
  ggplot() +
  geom_col(aes(y = share, x = raceeth, fill = dti)) +
  geom_text(aes(y = share, x = raceeth, group = dti, label = ratio, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  facet_grid(cols = vars(area)) +
  labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - DTI RATIO BY COMPARISON BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("DTI Ratios by Race & Ethnicity"),
          race_msa_dti_purchase_plot,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          urbn_note("Purchased Loans Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Loan Channel}

Among those who purchased homes in 2019, a higher share of borrowers in the City of Detroit and the MSA used FHA loans compared to those in the US. The share of conventional loans was similar in all three regions, while the share of VA loans was higher in the US.

```{r include = FALSE}
channel_function = function(data, ...) {
  data %>% 
  group_by(channel) %>% 
  filter(channel!="NA") %>% 
  summarize(n = sum(n),
            pct_n = n / sum(.$n))
}
```

```{r include = FALSE}
loan_city <- purchase_df %>%
  filter(city_level == 1) %>%
  channel_function() %>%
  mutate(area = city_title_df)

loan_msa <- purchase_df %>%
  filter(city_msa == 1) %>% 
  channel_function() %>%
  mutate(area = msa_title_df)

loan_us <- purchase_df %>%
  channel_function() %>%
  mutate(area = "US") %>%
  bind_rows(loan_city, loan_msa) %>%
  mutate(value_label = percentLabel(pct_n),
         area = factor(area, levels = c("US", city_title_df, msa_title_df)),
         font = factor(case_when(channel == "FHA" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  data.frame()

channel_plot <- loan_us %>% 
  ggplot() +
  geom_col(aes(y = pct_n, x = area, fill = channel)) +
  geom_text(aes(y = pct_n, x = area, group = channel, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
   labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=6, fig.height=3.5}
# - PLOT - LOAN CHANNEL BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("2019 Loan Channel Comparison"),
          channel_plot,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          urbn_note("Purchased Loans Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

In both the City of Detroit and the MSA, FHA loans account for a higher share of loan channel composition for Black households compared to any other race group. In 2019, the FHA share of loans for Black households is 31 percent in the City of Detroit, and 37 percent in Detroit MSA.

```{r include = FALSE}
race_city_loan_plot <- purchase_df %>% 
  filter(raceeth!="-2" & raceeth!="AIAN" & raceeth!="NHPI") %>%
  filter(city_level == 1) %>%
  mutate(area = city_title_df)
  
race_loan_plot <- purchase_df %>% 
  filter(raceeth!="-2" & raceeth!="AIAN" & raceeth!="NHPI") %>%
  filter(city_msa == 1) %>%
  mutate(area = msa_title_df) %>%
  bind_rows(race_city_loan_plot) %>%
  mutate(area = factor(area, levels = c(city_title_df, msa_title_df))) %>%
  group_by(area, raceeth) %>% 
  count(channel) %>%
  drop_na(channel) %>%
  mutate(share = n/sum(n),
         ratio = percentLabel(share),
        font = factor(case_when(channel == "FHA" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  arrange(raceeth, desc(channel)) %>%
  ggplot() +
  geom_col(aes(y = share, x = raceeth, fill = channel)) +
  geom_text(aes(y = share, x = raceeth, group = channel, label = ratio, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  facet_grid(cols = vars(area)) +
  labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - LOAN CHANNEL COMPARISON BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Loan Channel by Race & Ethnicity"),
          race_loan_plot,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          urbn_note("Purchased Loans Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Loan to Value Ratio}

Homebuyers in the city purchased homes with a higher LTV ratio. About 47 percent of households have LTV of 90 percent and above, compared to 38 percent in the MSA, and 36 percent in the US as a whole. Higher LTV is associated with greater risk and takes a longer time to build wealth for homeowners who put less equity down at the time of purchase.

```{r}
ltv_function = function(data, ...) {
  data %>% 
  group_by(ltv) %>% 
  filter(ltv!="NA") %>% 
  summarize(n = sum(n),
            pct_n = n / sum(.$n))
}
```

```{r}
ltv_city <- purchase_df %>%
  filter(city_level == 1) %>%
  ltv_function() %>%
  mutate(area = city_title_df)

ltv_msa <- purchase_df %>%
  filter(city_msa == 1) %>% 
  ltv_function() %>%
  mutate(area = msa_title_df)

ltv_us <- purchase_df %>%
  ltv_function() %>%
  mutate(area = "US") %>%
  bind_rows(ltv_city, ltv_msa) %>%
  mutate(value_label = percentLabel(pct_n),
         area = factor(area, levels = c("US", city_title_df, msa_title_df)),
         font = factor(case_when(ltv == ">100%" ~ "1",
                                 ltv == "80-89%" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  data.frame()

ltv_plot <- ltv_us %>% 
  ggplot() +
  geom_col(aes(y = pct_n, x = area, fill = ltv)) +
  geom_text(aes(y = pct_n, x = area, group = ltv, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
   labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=6, fig.height=3.5}
# - PLOT - LTV RATIO BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("2019 LTV Ratios Comparison"),
          ltv_plot,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          urbn_note("Purchased Loans Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

Black homebuyers have higher loan-to-value (LTV) ratios compared to other racial and ethnic groups in the US. The share of Black borrowers with LTV ratios of 90 percent and above is 56 percent in the city, and 61 percent in the MSA. These shares above 90 percent are significantly higher compared to the shares for white borrowers, at 38 percent in the city, and 36 percent in the MSA.

```{r include = FALSE}
race_city_ltv_plot <- purchase_df %>% 
  filter(raceeth!="-2" & raceeth!="AIAN" & raceeth!="NHPI") %>%
  filter(city_level == 1) %>%
  mutate(area = city_title_df)

race_ltv_plot <- purchase_df %>% 
  filter(raceeth!="-2" & raceeth!="AIAN" & raceeth!="NHPI") %>%
  filter(city_msa == 1) %>%
  mutate(area = msa_title_df) %>%
  bind_rows(race_city_ltv_plot) %>%
  mutate(area = factor(area, levels = c(city_title_df, msa_title_df))) %>%
  group_by(area, raceeth) %>% 
  count(ltv) %>%
  drop_na(ltv) %>%
  mutate(share = n/sum(n),
         ratio = percentLabel(share),
        font = factor(case_when(ltv == ">100%" ~ "1",
                                 ltv == "80-89%" ~ "1",
                          TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  arrange(raceeth, desc(ltv)) %>%
  ggplot() +
  geom_col(aes(y = share, x = raceeth, fill = ltv)) +
  geom_text(aes(y = share, x = raceeth, group = ltv, label = ratio, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
    scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  facet_grid(cols = vars(area)) +
  labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=8, fig.height=4.5}
# - PLOT - LTV RATIO COMPARISON BY RACE
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("LTV Ratios by Race & Ethnicity"),
          race_ltv_plot,
          urbn_source("2019 Home Mortgage Disclosure Act"),
          urbn_note("Purchased Loans Only"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Mortgage Ready}

Mortgage-ready population, calculated by Freddie Mac, is borrowers age 45 or younger who does not have a mortgage but has the credit characteristics to qualify for a mortgage. Freddie uses credit scores, debt to income ratio, and delinquency histories to estimate this number. As of 2021 January, there was about 41 million mortgage-ready population in the US housing market and 3.4 million were black people. In the Detroit MSAs, there was close to 500 thousand mortgage-ready population, of whom 60 thousand were Black people.

```{r include = FALSE}
mort_ready_df2 <- mort_ready_df %>%
  filter(!str_detect(geo, "Source")) %>%
  gather(`White_Mortgage Ready`, value, -geo) %>%
  separate(`White_Mortgage Ready`, c("Race & Ethnicity","mort_ready"), sep="_") %>%
  filter(mort_ready == "Mortgage Ready") %>%
  filter(str_detect(geo, city_name) | str_detect(geo, "United States")) %>%
  dplyr::select(-mort_ready) %>%
  spread(`Race & Ethnicity`, value) %>%
  group_by(geo) %>%
  mutate(Total = sum(Asian+Black+Hispanic+White+Other)) %>%
  gather(`Race & Ethnicity`, value, -geo) %>%
  ungroup() %>%
  mutate(area = if_else(geo == "United States", "United States", msa_title_df),
         `Number of Persons Mortgage Ready` = comma(value),
         `Race & Ethnicity` = factor(`Race & Ethnicity`, levels = c("Total","Other","White","Hispanic","Black","Asian"))) %>%
  dplyr::select(area, `Race & Ethnicity`, `Number of Persons Mortgage Ready`) %>%
  spread(area, `Number of Persons Mortgage Ready`) %>%
  arrange(desc(`Race & Ethnicity`))
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
set_urbn_defaults(style = "print")
# - TABLE - MORTGAGE READY BY RACE/MSA
set_urbn_defaults(style = "print")
mort_ready_df2 %>%
  gt() %>%
  tab_header(
    title = md(glue::glue("**Table 2. Mortgage Ready Count by Race & Ethnicity: {msa_title_df}**"))
  ) %>%
  fmt_markdown(
    columns = `Race & Ethnicity`
  ) %>%
  tab_source_note(
    source_note = md("**Source**: 2021 Freddie Mac")
  )
```

In Detroit, mortgage-ready Black population is concentrated in the Wayne county. About a half of the mortgage-ready Blacks are in the Wayne county. 

```{r include = FALSE}
detroit_mort_ready_df <- counties_sf %>%
  full_join(detroit_mort_ready, by = "county") %>%
  mutate(value_label = factor(value_label, levels = c("Less than 5k","More than 5k","More than 10k","More than 25k"))) 

detroit_mort_ready_map <- detroit_mort_ready_df %>% 
  ggplot() +
  geom_sf(mapping = aes(fill = value_label),
          color = "#ffffff", size = 0.25) +
  geom_sf_label(aes(label = county_name), size = 2) +
  scale_fill_manual(labels = c("Less than 5k","More than 5k","More than 10k","More than 25k"),
                    values = c("#cfe8f3","#73bfe2","#1696d2","#0a4c6a"),
                    guide = guide_legend(ncol = 1)) +
  coord_sf(datum = NA) +
  labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0), 
        legend.position = "left",
         axis.ticks.y=element_blank(),
         axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank())
```

```{r fig.align = 'left', fig.width=8, fig.height=3}
set_urbn_defaults(style = "map")
urbn_plot(urbn_title("Size of 'Mortgage Ready' Black Population by County"),
          detroit_mort_ready_map,
          urbn_source("2021 Freddie Mac"),
          heights = c(0.05, 1, 0.05, 0.05))
```

Black people have a lower share of those who are mortgage-ready. This share is even lower for Black people in Detroit (18 percent) compared to the nation (22 percent). This is in line with the lower credit score and income for Black people living in Detroit. Despite the lower share of mortgage-ready people in Detroit MSA, there is a higher share of those who can afford a mortgage among the mortgage-ready population. For example, 45 percent of Mortgage ready Black people can afford median-priced homes assuming a 2.9 percent mortgage rate compared to 76 percent in Detroit. This is because the home prices are much lower in Detroit MSA compared to the nation. Also due to the lower home prices, the years to save for 3 percent downpayment is shorter in Detroit MSAs compared to the whole nation. In Detroit, it takes about 1.72 years for mortgage-ready Black people to save 3 percent down payment, compared to 2.71 years for those in the nation.  

```{r include = FALSE}
time_save_df2 <- time_save_df %>%
  filter(!str_detect(geo, "Source")) %>%
  drop_na() %>%
  filter(str_detect(geo, city_name) | str_detect(geo, "United States")) %>%
  mutate(area = if_else(geo == "United States", "United States", "MSA")) %>%
  dplyr::select(-geo) %>%
  gather(`White_% Mortgage Ready`, value, -area) %>%
  separate(`White_% Mortgage Ready`, c("Race & Ethnicity","Indicator"), sep="_") %>%
  filter(`Race & Ethnicity` != "Other") %>%
  mutate(Value = case_when(Indicator != "Time to Save 3% Downpayment (in Years)" ~ percentLabel(value),
                                 TRUE ~ as.character(round(value, digits = 2))),
         `Race & Ethnicity` = factor(`Race & Ethnicity`, levels = c("White","Hispanic","Black","Asian"))) %>%
  dplyr::select(-value) %>%
  spread(Indicator, Value) %>%
  arrange(desc(area),desc(`Race & Ethnicity`)) %>%
  pivot_wider(names_from = "area", 
            values_from = c(`% Mortgage Ready`, `Affordability 2.9% Mortgage Rate`, `Time to Save 3% Downpayment (in Years)`))
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
# - TABLE - TIME TO SAVE BY RACE/MSA
set_urbn_defaults(style = "print")
time_save_df2 %>%
  gt() %>%
  tab_header(
    title = md(glue::glue("**Table 3. Time for Down Payment by Race & Ethnicity: {msa_title_df}**"))
  ) %>%
  fmt_markdown(
    columns = `Race & Ethnicity`
  ) %>%
  tab_spanner(
    label = "% Mortgage Ready",
    columns = 2:3,
  ) %>%
  tab_spanner(
    label = "Affordability 2.9% Mortgage Rate",
    columns = 4:5,
  ) %>%
  tab_spanner(
    label = "Years to Save 3% Downpayment",
    columns = 6:7,
  ) %>%
  cols_label(
    `% Mortgage Ready_United States` = html("United States"),
    `% Mortgage Ready_MSA` = html(md(glue::glue("{msa_title_df}"))),
    `Affordability 2.9% Mortgage Rate_United States` = "United States",
    `Affordability 2.9% Mortgage Rate_MSA` = html(md(glue::glue("{msa_title_df}"))),
    `Time to Save 3% Downpayment (in Years)_United States` = "United States",
    `Time to Save 3% Downpayment (in Years)_MSA` = html(md(glue::glue("{msa_title_df}"))),
  ) %>%
  tab_source_note(
    source_note = md("**Source**: 2021 Freddie Mac")
  )
```

\newpage{}

\urbnheadingone{Home Prices}

\urbnheadingtwo{House Price Appreciation}

Home prices in Detroit were hit hard in the wake of the 2008 housing bust, losing significantly more value than the US market as a whole.

```{r include = FALSE}
hpi_function = function(data, ...) {
  data %>% 
  separate(col = geo, into = c("city", "state"), sep = ",") %>%
  mutate(city = str_to_title(city),
         geo = str_c(city, ",", state),
         date = as.Date(date, "%Y-%m-%d")) %>%
  filter(date > "2003-01-01") %>%
  dplyr::select(-city, -state)
}
```

```{r include = FALSE}
city_hpi_df <- city_hpi %>%
  hpi_function() %>%
  mutate(area = city_title_df)

msa_hpi_df <- msa_hpi %>%
  hpi_function() %>%
  mutate(area = msa_title_df)

city_comp_plot <- city_comp %>%
  filter(geo == "United States") %>%
  mutate(area = "United States") %>%
  bind_rows(city_hpi_df, msa_hpi_df) %>%
  mutate(area = factor(area,
                       levels = c("United States", city_title_df, msa_title_df))) %>%
  ggplot() +
  geom_line(aes(y = `BlackKnight HPI year-over-year`, x = date, color = area)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                      limits = c(-0.65, 0.25)) +
  labs(y = "Year-over-year home price change", x = "Date") 
```

```{r fig.align = 'center', fig.width=8, fig.height=2.75}
# - PLOT - YEAR PRICE CHANGES BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Year-over-year Price Changes"),
          city_comp_plot,
          urbn_source("Black Knight\n"),
          heights = c(0.05, 1, 0.05, 0.05))
```

In the City of Detroit, the homes prices for those in the lowest price tier – bottom 20 percentile – dropped the most during the Great Recession. However, in most recent years, these homes show higher appreciation rate as the developers have built more higher priced homes because of the rising cost.

```{r include = FALSE}
city_tiers_plot <- city_tiers %>%
  hpi_function() %>%
  mutate(price_tier = gsub(" year-over-year", "", name),
         price_tier = factor(price_tier, 
                             levels = c("Highest Tier","Middle Tier","Lowest Tier"))) %>%
  ggplot() +
  geom_line(aes(y = value, x = date, color = price_tier)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                      limits = c(-0.65, 0.25)) +
  labs(y = "Year-over-year home price change", x = "Date")
```

```{r fig.align = 'center', fig.width=8, fig.height=2.75}
# - PLOT - YEAR PRICE CHANGES BY PRICE TIER BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Year-over-year Price Changes by Price Tier: {city_title_df}")),
          city_tiers_plot,
          urbn_source("Black Knight"),
          heights = c(0.05, 1, 0.05, 0.05))
```

Nationally, average home prices are 29 percent above where they were during the prior peak, however average home values in the city remain below peak value by 43 percent, though prices are up 166 percent from their nadir.

```{r include = FALSE}
med_price_plot <- med_price %>%
  filter(AggValueName != "United States") %>%
  separate(col = AggValueName, into = c("city", "state"), sep = ",") %>%
  mutate(city = str_to_title(city),
         geo = str_c(city, ",", state)) %>%
  dplyr::select(-city, -state) %>%
  bind_rows(med_price %>%
              filter(AggValueName == "United States") %>% 
              mutate(geo = AggValueName) %>% 
              dplyr::select(-AggValueName)) %>% 
  mutate(date = as.character(yyyymm),
         date = paste0(date, "01"),
         date = ymd(date),
         area = factor(case_when(AggTypeName == "MSA" ~ msa_title_df,
                                 AggTypeName == "City" ~ city_title_df,
                                 AggTypeName == "Nation" ~ "United States"),
                       levels = c("United States", city_title_df, msa_title_df))) %>%
  ggplot() +
  geom_line(aes(y = hpi, x = date, color = area)) +
  scale_y_continuous(labels = scales::dollar_format(),
                     breaks = c(0,50000,100000,150000,200000,250000,300000,350000)) +
  labs(y = "Home Price Estimate", x = "Date") 
```

```{r fig.align = 'center', fig.width=8, fig.height=2.75}
# - PLOT - AVG HOME PRICE EST. CHANGES BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Average Home Price Estimate"),
          med_price_plot,
          urbn_source("Black Knight"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Home Values by Households}

As home prices fell significantly in the City of Detroit following the Great Recession, the median home value for all race and ethnic groups dropped significantly. While median home values for other race and ethnic groups have gone up in the years 2015 to 2019 compared to 2010 to 2014, the median home value for Black households slightly dropped further. In the Detroit MSA, home values have recovered for all race and ethnic groups during the last 10 years but Black households still have the lowest median home values, showing that even among homeowners there are substantial disparities in housing wealth.

```{r include = FALSE}
city_hhval_race <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(!!as.symbol(city_df) == TRUE) %>%
  filter(own == 1) %>% 
  group_by(raceeth, acs_year) %>% 
  summarise(med_hv = median(rep(adjhv, hhwt))) %>%
  mutate(area = city_title_df)

race_hhval <- acs_hh %>% 
  filter(raceeth!="Other") %>% 
  filter(own == 1) %>% 
  group_by(raceeth, acs_year) %>% 
  summarise(med_hv = median(rep(adjhv, hhwt))) %>%
  mutate(area = msa_title_df) %>%
  bind_rows(city_hhval_race) %>%
  mutate(raceeth = factor(raceeth, 
                          levels = c("Asian", "Black", "Hispanic", "White")),
         val_lab2009 = if_else(acs_year == "2005-09", dollarLabel_k(med_hv), "NA"),
         val_lab2019 = if_else(acs_year == "2015-19", dollarLabel_k(med_hv), "NA"),
         val_lab2009 = gsub(" ", "", val_lab2009, fixed = TRUE),
         val_lab2019 = gsub(" ", "", val_lab2019, fixed = TRUE)) %>%
  na_if("NA")

hhval_plot <- race_hhval %>% 
  ggplot(mapping = aes(x = acs_year, y = med_hv, color = raceeth, group = raceeth)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12)),
                     labels = scales::percent,
                     limits = c(0,425000)) +
  geom_text_repel(aes(y = med_hv, x = acs_year, group = acs_year, label = val_lab2019), 
            size = 2, hjust = -1.0, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  geom_text_repel(aes(y = med_hv, x = acs_year, group = acs_year, label = val_lab2009), 
            size = 2, hjust = 2.75, direction = "y",
            segment.color = 'transparent',
            color = "#000000") +
  facet_grid(cols = vars(area)) +
  labs(y = NULL, x = NULL) +
  remove_ticks() + 
  remove_axis() +
  theme(legend.position = "top",
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank())
```

```{r fig.align = 'center', fig.width=8, fig.height=3.5}
set_urbn_defaults(style = "print")
urbn_plot(urbn_title("Median Household Value by Race & Ethnicity"),
          hhval_plot,
          urbn_source("American Community Survey"),
          urbn_note("2019 Inflation Adjusted Dollars"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Home Values by Neighborhoods}

In terms of market valuation, the distributions of single family homes and duplexes are in line with each other. The highest value homes are concentrated around downtown and the riverfront, as well as around Palmer Park west of Woodward, near the boundary with suburban Ferndale.

```{r include = FALSE}
city_structure_df <- city_structure %>%
  mutate(id = as.character(tract)) %>%
  group_by(id, landuse) %>%
  summarise(count = n(),
            value_mean = mean(markettotalvalue)) %>%
  group_by(id) %>%
  mutate(total = sum(count),
         share = round(count/total, digits = 3),
         share_label = percentLabel(share)) %>%
  left_join(city_tract, by = c("id"))

centroid <- aggregate(cbind(long,lat) ~ id, data = city_structure_df, FUN = mean) %>%
  rename(long_label = long,
         lat_label = lat)
```

```{r include = FALSE}
family_tract <- city_structure_df %>% filter(landuse == "Single Family") %>% left_join(centroid)
# mean market value single family
family_value_tract_map <- ggmap(city_map) +
  geom_polygon(data = family_tract, 
               aes(x = long, y = lat, group = group, fill = value_mean), 
               color = "#353535", alpha = 0.85, size = 0.25) +
  scale_fill_gradient(high = "#1696d2", low = "#f5f5f5", limits = c(0,400000), labels = scales::dollar_format(accuracy = 1)) +
  coord_sf(crs = st_crs(4326)) +
  labs(x = NULL, y = NULL) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank(),
        legend.position = "right", 
        legend.title = element_blank())
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
# - MAP - MEAN MARKET VALUE - SINGLE FAMILY HOMES
set_urbn_defaults(style = "map")
urbn_plot(urbn_title(glue::glue("Mean Market Value of Single-Family Homes, Tract Level: {city_title_df}")),
          family_value_tract_map,
          urbn_source("Property Records"),
          heights = c(0.05, 1, 0.05, 0.05))
```

```{r include = FALSE}
duplex_tract <- city_structure_df %>% filter(landuse == "Duplex") %>% left_join(centroid)

# mean market value duplex
duplex_value_tract_map <- ggmap(city_map) +
  geom_polygon(data = duplex_tract, 
               aes(x = long, y = lat, group = group, fill = value_mean), 
               color = "#353535", alpha = 0.75, size = 0.25) +
 
  scale_fill_gradient(high = "#ec008b", low = "#f5f5f5", limits = c(0,300000), labels = scales::dollar_format(accuracy = 1)) +
  labs(x = NULL, y = NULL) +
  coord_sf(crs = st_crs(4326)) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank(),
        legend.position = "right", 
        legend.title = element_blank()) 
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
# - MAP - MEAN MARKET VALUE - DUPLEXES
set_urbn_defaults(style = "map")
urbn_plot(urbn_title(glue::glue("Mean Market Value of Duplexes, Tract Level: {city_title_df}")),
          duplex_value_tract_map,
          urbn_source("Property Records"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingone{Housing Supply}

\urbnheadingtwo{Building Permits}

The US has experienced significant housing supply shortages in the past decade. The new supply has been slow to enter into the market despite the growing population. In the Detroit MSA, the number of new private housing units authorized by building permits has dropped significantly following the Great Recession. The number slowly recovered since but has dipped when the COVID-19 pandemic hit the nation. The numbers have gone up in recent months but the numbers are still considerably lower than years before the Great Recession. This trend is similar to the national trend.

```{r include = FALSE}
national_housingunits_df2 <- national_housingunits_df %>%
  mutate(date = as.Date(DATE, format = "%m/%d/%Y"),
         area = "US") %>%
  filter(date >= "2000-01-01" & date <= "2021-05-01") %>%
  mutate(date2 = as.Date(date, format = "%Y-%m-%d"),
         month = substr(date, start = 6, stop = 7),
         year = substr(date, start = 1, stop = 4),
         date3 = paste(year, month, sep = "-"),
         date4 = as.yearmon(date3),
         date5 = as.Date(date4, format = "%mon %Y"),
         PERMITk = PERMIT*1000) %>%
  group_by(date5, area) %>%
  summarise(housingunits_sum = sum(PERMIT))
```


```{r include = FALSE}
housingunits_plot <- housingunits_df %>%
  mutate(date = as.Date(DATE, format = "%m/%d/%y"),
         area = msa_title_df) %>%
  filter(date >= "2000-01-01" & date <= "2021-05-01") %>%
  mutate(date2 = as.Date(date, format = "%Y-%m-%d"),
         month = substr(date, start = 6, stop = 7),
         year = substr(date, start = 1, stop = 4),
         date3 = paste(year, month, sep = "-"),
         date4 = as.yearmon(date3),
         date5 = as.Date(date4, format = "%mon %Y")) %>%
  group_by(date5, area) %>%
  summarise(housingunits_sum = sum(DETR826BPPRIVSA)) %>%
  bind_rows(national_housingunits_df2) %>%
  mutate(area = factor(area, levels = c("US", msa_title_df))) %>%
  ggplot(aes(y = housingunits_sum, x = date5, color = area)) +
  geom_line() +
  scale_y_continuous(limits = c(0,2300),
                     labels = scales::comma_format(),
                     sec.axis = sec_axis(~.*1000,
                                         labels = scales::comma_format())) +
  labs(x = NULL, y = NULL, color = NULL) +
  theme(legend.position = "top",
         plot.caption = element_text(hjust = 0),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank(),
         axis.text.y = element_text(color = "#e88e2d"),
         axis.text.y.right = element_text(color = "#12719e"))
ggsave("output/housingunits_plot.png", housingunits_plot, width = 12, height = 7, device = "png")
```

```{r fig.align = 'center', fig.width=6, fig.height=2.5}
# - PLOT - BUILDING PERMITS
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("New Housing Units Authorized by Building Permits Comparison")),
          housingunits_plot,
          urbn_source("Census Bureau"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\urbnheadingtwo{Housing Inventory}

The housing inventory has dropped amidst the pandemic as the housing shortage continued while the demand went up as the mortgage rate dropped and the millennials entered their prime home-buying age. Between January 2018 and May 2021, the housing inventories dropped 31 percent in the US, 15 percent in the City of Detroit, and 21 percent in Detroit MSA. The annual inventory per household was the lowest in the City.

```{r include = FALSE}
hous_invent_df <- hous_invent %>%
  dplyr::select(7:10)

hous_invent_df <- hous_invent_df[c(1, 3:5),]

hous_invent_df2 <- hous_invent_df %>%
  gather(geo, value, -Year) %>%
  mutate(area = factor(case_when(str_detect(geo, "United States") ~ "United States",
                                 str_detect(geo, "City") ~ "City",
                                 str_detect(geo, "MSA") ~ "MSA"),
                       levels = c("United States", "City", "MSA")),
         value_label = percentLabel(value)) %>%
  dplyr::select(-geo, -value) %>%
  pivot_wider(names_from = "area", 
             values_from = "value_label") %>%
  mutate(value_type = case_when(Year == "Jan 2018-May 2021" ~ "Changes in Inventory",
                                TRUE ~ as.character("Inventory Per Households")))

hous_invent_changes <- hous_invent_df2 %>%
  filter(value_type == "Changes in Inventory") %>%
  pivot_wider(names_from = "value_type", 
             values_from = c(`United States`, City, MSA))
  
hous_invent_hshlds <- hous_invent_df2 %>%
  filter(value_type == "Inventory Per Households") %>%
  pivot_wider(names_from = "value_type", 
             values_from = c(`United States`, City, MSA))
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
set_urbn_defaults(style = "print")
hous_invent_changes %>%
  gt() %>%
  tab_header(
    title = md("**Table 4. Changes in Housing Inventory**")
  ) %>%
  fmt_markdown(
    columns = Year
  ) %>%
  cols_label(
    Year = "Timeframe",
    `United States_Changes in Inventory` = "United States",
    `City_Changes in Inventory` = glue::glue("{city_title_df}"),
    `MSA_Changes in Inventory` = glue::glue("{msa_title_df}")
  ) %>%
  tab_source_note(
    source_note = md("**Source**: Zillow")
  )
```

```{r fig.align = 'center', fig.width=6, fig.height=4.5}
set_urbn_defaults(style = "print")
hous_invent_hshlds %>%
  gt() %>%
  tab_header(
    title = md("**Table 5. Inventory Per Households**")
  ) %>%
  fmt_markdown(
    columns = Year
  ) %>%
  cols_label(
    Year = "Year",
    `United States_Inventory Per Households` = "United States",
    `City_Inventory Per Households` = glue::glue("{city_title_df}"),
    `MSA_Inventory Per Households` = glue::glue("{msa_title_df}")
  ) %>%
  tab_source_note(
    source_note = md("**Source**: Zillow")
  )
```

\newpage{}

\urbnheadingtwo{Days to Pending}

The homes are selling faster in 2020 and 2021 than in years in the past. In other years, average days of pending dropped during the first half of the year and then goes up, reflecting the seasonality. However, in 2020 the average days of pending continued to drop.

```{r include = FALSE}
days_pend_df <- days_pend %>%
  gather(geo, value, -date) %>%
  mutate(date2 = as.Date(date, format = "%Y-%m-%d"), 
         geo = factor(geo, levels = c("United States",glue::glue("{city_title_df}"),glue::glue("{msa_title_df}")))) %>%
  ggplot() + 
  geom_line(aes(y = value, x = date2, color = geo)) +
  labs(y = NULL, x = NULL, fill = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top") +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r fig.align = 'center', fig.width=6, fig.height=2.5}
# - PLOT - DAYS PENDING 
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Days to Pending Comparison")),
          days_pend_df,
          urbn_source("Zillow"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Housing Type}

Similar to the nationwide composition of housing structure types, households in both the city and MSA are largely living in single-family units. Among those living in multi-family units, a significant proportion of households in the city, primarily renters, reside in large-scale buildings with 50 or more units, which make up around 10 percent of the overall composition. In the MSA, buildings with 5-19 units make up the largest share of multi-family units and account for around 9 percent of the overall composition.

```{r include = FALSE}
size_comp_function1 = function(data, ...) {
  data %>% 
  drop_na() %>%
  group_by(TYPE) %>%
  summarise(count = sum(n)) %>%
  ungroup() %>%
  mutate(total = sum(count),
         share = count/total,
         value_label = percentLabel(share))
}
```

```{r include = FALSE}
size_renter_national <- fread("data/size_renter_national.csv")
size_owner_national <- fread("data/size_owner_national.csv")

size_total_national <- size_renter_national %>%
  bind_rows(size_owner_national) %>%
  size_comp_function1() %>%
  mutate(area = "US")

size_owner_city <- fread("data/size_owner_city.csv")
size_renter_city <- fread("data/size_renter_city.csv")

size_total_city <- size_renter_city %>%
  bind_rows(size_owner_city) %>%
  size_comp_function1() %>%
  mutate(area = city_title_df)

size_owner_msa <- fread("data/size_owner_msa.csv")
size_renter_msa <- fread("data/size_renter_msa.csv")

size_total_msa <- size_renter_msa %>%
  bind_rows(size_owner_msa) %>%
  size_comp_function1()  %>%
  mutate(area = msa_title_df)

size_total_national_df <- size_total_national %>%
  bind_rows(size_total_city, size_total_msa) %>%
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df)),
         type = factor(TYPE, 
                         levels = c("Mobile Home", "Single Family Attached", "Single Family Detached",
                                    "2-4 Units", "5-19 Units", "20-49 Units", "50+ Units")),
         font = factor(case_when(type == "Mobile Home" ~ "0",
                                 type == "Single Family Detached" ~ "0",
                                 type == "50+ Units" ~ "0",
                                 TRUE ~ as.character("1")),
                       levels = c("0","1")))
```

```{r include = FALSE}
size_total_plot <- size_total_national_df %>%
  ggplot() + 
  geom_col(aes(y = share, x = area, fill = type), position = "fill") +
  geom_text(aes(y = share, x = area, group = type, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  labs(y = NULL, x = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank())
```

```{r fig.align = 'center', fig.width=8, fig.height = 4}
# - PLOT - HOUSING STRUCTURE BY HOUSEHOLD BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Housing Structure Type Comparison")),
          size_total_plot,
          urbn_source("2015-19 American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

The most common property types in Detroit are single-family, condominiums, and duplexes. Single-family housing dominates the entire residential market, consisting of 96 percent of the market share. Neighborhoods comprised of more than 80 percent of Black households have a lower share of condominiums and greater share of duplexes.

```{r include = FALSE}
size_comp_function2 = function(data, ...) {
  data %>% 
    mutate(total = sum(n),
           share = n/total,
           value_label = percentLabel(share),
           type = factor(TYPE, 
                         levels = c("Mobile Home", "Single Family Attached", "Single Family Detached",
                                    "2-4 Units", "5-19 Units", "20-49 Units", "50+ Units")),
           font = factor(case_when(type == "Mobile Home" & status == "Owners" ~ "0",
                            type == "Mobile Home" & status == "Renters" ~ "0",
                            type == "Single Family Detached" & status == "Owners" ~ "0",
                            type == "Single Family Detached" & status == "Renters" ~ "0",
                            type == "50+ Units" & status == "Owners" ~ "0",
                            type == "50+ Units" & status == "Renters" ~ "0",
                            TRUE ~ as.character("1")),
                         levels = c("0","1")))  %>%
  dplyr::select(-V1, -n, -total)  %>%
  drop_na(TYPE)
}
```

```{r include = FALSE}
size_renter_city_df <- size_renter_city %>%
  mutate(area = city_title_df, status = "Renters") %>%
  size_comp_function2()

size_renter_msa_df <- size_renter_msa %>%
  mutate(area = msa_title_df, status = "Renters") %>%
  size_comp_function2()

size_renter <- size_renter_national %>%
  mutate(area = "US", status = "Renters") %>%
  size_comp_function2() %>%
  bind_rows(size_renter_city_df, size_renter_msa_df)
```

```{r include = FALSE}
size_owner_city_df <- size_owner_city %>%
  mutate(area = city_title_df, status = "Owners") %>%
    size_comp_function2()

size_owner_msa_df <- size_owner_msa %>%
  mutate(area = msa_title_df, status = "Owners") %>%
    size_comp_function2()

size_owner <- size_owner_national %>%
  mutate(area = "US", status = "Owners") %>%
  size_comp_function2() %>%
  bind_rows(size_owner_city_df, size_owner_msa_df)
```

```{r include = FALSE}
size_plot <- size_renter %>%
  bind_rows(size_owner) %>%
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot() + 
  geom_col(aes(y = share, x = status, fill = type), position = "fill") +
  geom_text(aes(y = share, x = status, group = type, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)),
                     labels = scales::percent) +
      scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  facet_grid(cols = vars(area)) +
  labs(y = NULL, x = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank())
```

```{r fig.align = 'center', fig.width=8, fig.height = 4}
# - PLOT - HOUSING STRUCTURE TYPE OWNERS AND RENTERS
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Housing Structure Type: Owners & Renters")),
          size_plot,
          urbn_source("2015-19 American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

\newpage{}

\urbnheadingtwo{Age of Housing}

Compared to the overall composition of the nation, households in both the City of Detroit and the MSA are living in older homes, with a higher share of homes built before 1980. Nationwide, only 53percent of households live in homes built before 1980, compared to 65 percent in the City of Detroit and 78 percent in the MSA.

While new construction has slowed dramatically across the nation since the Great Recession, Detroit’s share of households living in homes built since 2010 is much lower than nationwide. Only 1 percent of households living in the City reside in homes built since 2010, compared to 3 percent in the and 7 percent nationally.

```{r include = FALSE}
age_comp_function1 = function(data, ...) {
  data %>% 
  mutate(count = sum(n),
         share = n/count,
         value_label = percentLabel(share),
         age = factor(AGE, 
                      levels = c("Before 1940","1940-1959","1960-1979","1980-1999","2000-2009","Since 2010")),
         font = factor(case_when(age == "Before 1940" ~ "0",
                                 age == "1960-1979" ~ "0",
                                 TRUE ~ as.character("1")),
                       levels = c("0","1")))
}
```

```{r include = FALSE}
ages_renter_national <- fread("data/ages_renter_national.csv")
ages_owner_national <- fread("data/ages_owner_national.csv")

ages_national <- ages_owner_national %>%
  age_comp_function1() %>%
  mutate(area = "US")

ages_total_city <- fread("data/ages_total_city.csv")

ages_city <- ages_total_city %>%
  age_comp_function1() %>%
  mutate(area = city_title_df)

ages_total_msa <- fread("data/ages_total_msa.csv")

ages_comparison <- ages_total_msa %>%
  age_comp_function1() %>%
  mutate(area = msa_title_df) %>%
  bind_rows(ages_national, ages_city) %>%
  mutate(area = factor(area, levels = c("US", city_title_df, msa_title_df))) %>%
  ggplot() +
  geom_col(aes(y = share, x = area, fill = age), position = "fill") +
  geom_text(aes(y = share, x = area, group = age, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)),
                     labels = scales::percent) +
  scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  labs(y = NULL, x = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank())
```

```{r fig.align = 'center', fig.width=8, fig.height = 4}
# - PLOT - YEAR BUILT COMPOSITION BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Year Built Comparison")),
          ages_comparison,
          urbn_source("2015-19 American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

In both the city and MSA, greater shares of Black households are living in homes built prior to 1960 compared to other races. In the City, 64 percent of Black households are living in homes built prior to 1960 compared to only 43 percent of white households. Some 50percent of Hispanic households and 49 percent of white households are living in homes built after 2000.

```{r include = FALSE}
age_comp_function2 = function(data, ...) {
  data %>% 
  drop_na() %>%
  group_by(RACE_NEW) %>%
  mutate(count = sum(n),
         share = n/count,
         value_label = percentLabel(share),
         age = factor(AGE, 
                      levels = c("Before 1940","1940-1959","1960-1979","1980-1999","2000-2009","Since 2010")),
         font = factor(case_when(age == "Before 1940" ~ "0",
                                 age == "1960-1979" ~ "0",
                                 TRUE ~ as.character("1")),
                       levels = c("0","1")),
         raceeth = factor(RACE_NEW,
                          levels = c("Asian","Black","Hispanic","White")))
}
```

```{r include = FALSE}
ages_race_msa <- fread("data/ages_race_msa.csv")

ages_race_msa_df <- ages_race_msa %>%
  age_comp_function2() %>%
  mutate(area = msa_title_df)

ages_race_city <- fread("data/ages_race_city.csv")

ages_race_plot <- ages_race_city %>%
  age_comp_function2() %>%
  mutate(area = city_title_df) %>%
  bind_rows(ages_race_msa_df) %>%
  ggplot() +
  geom_col(aes(y = share, x = raceeth, fill = age), position = "fill") +
  geom_text(aes(y = share, x = raceeth, group = age, label = value_label, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)),
                     labels = scales::percent) +
      scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
  facet_grid(cols = vars(area)) +
  labs(y = NULL, x = NULL) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = "top",
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        strip.background = element_blank())
```

```{r fig.align = 'center', fig.width=8, fig.height = 4}
# - PLOT - YEAR BUILT COMPOSITION BY RACE BY COMPARISON
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Year Built Composition by Race & Ethnicity")),
          ages_race_plot,
          urbn_source("2015-19 American Community Survey"),
          heights = c(0.05, 1, 0.05, 0.05))
```

```{r eval = FALSE}
\newpage{}

\urbnheadingone{Housing Choice Vouchers for Homeowners}

The Housing Choice Voucher (HCV) program is mostly known for its rental assistance, especially its tenant-based rental assistance. In those cases, the housing subsidy goes to the landlord. A small set of vouchers are set aside for homeownership. This program is active in all 50 states and is about 13,000 voucher participants for homeownership since 2015 nationwide. Only an average of 12 vouchers for homeowners was used in the City of Detroit since 2015, and 157 vouchers on average were used throughout the state of Michigan since 2015.

hcv_voucher <- hcv_voucher[c(1:2),]

hcv_voucher_df <- hcv_voucher %>%
  dplyr::select(-Average) %>%
  gather(year, value, -`PHA Name`) %>%
  group_by(year) %>%
  mutate(total = sum(value),
         share = value/total,
         value_label = percentLabel(share),
         geo = case_when(`PHA Name` == "All MI" ~ "Michigan",
                         `PHA Name` == "Detroit Housing Commission" ~ city_title_df),
         font = factor(case_when(geo == "Michigan" ~ "1",
                                 TRUE ~ as.character("0")),
                       levels = c("0","1"))) %>%
  data.frame() %>%
  ggplot() +
  geom_bar(aes(y = value, x = year, fill = geo), position="stack", stat="identity")+
  geom_text(aes(y = value, x = year, group = geo, label = value, color = font), 
            position = position_stack(vjust = .5), size = 3, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.01))) +
    scale_color_manual(name = NULL,
                     labels = c("0","1"),
                     values = c("white","black")) +
     labs(y = NULL, x = NULL, fill = NULL) +
  theme(legend.position = "top",
         axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
         panel.background = element_blank(),
         panel.grid.major = element_blank(),
         strip.background = element_blank()) +
  guides(fill = guide_legend(nrow = 1)) 
```

```{r eval = FALSE}
# - PLOT - NUMBER OF HCV HOMEOWNERSHIP VOUCHER 
set_urbn_defaults(style = "print")
urbn_plot(urbn_title(glue::glue("Number of HCV Homeownership Voucher: Detroit Housing Commission & Michigan")),
          hcv_voucher_df,
          urbn_source("HCV Homeownership Enrollments Report"),
          urbn_note("'Detroit' refers to the Detroit Housing Commission. 'All MI' refers to all HCV homeownership vouchers in the state of Michigan. The count of vouchers includes all new and current HCV homeownership families per year that have been assisted under the PHA’s HCV homeownership program as reported by the PHA in HUD’s IMS/PIC system."),
          heights = c(1, 30, 1.5, 2.5, 2.5))
```

\newpage{}

\urbnheadingone{Conclusion}




